##################################################################################################
#                                                                                                #    
#                                      ```...`                                                   #    
#                                   `......-::::.`...---.`                                       #    
#                                  ``     `.-::-.....---:::-`                                    #    
#                                           ..`      `.--:://-                                   #    
#                                     `//:`            .-:::/+:                                  #    
#                                    +m/`sy            `.-:://+`                                 #    
#                              `    :mMmdN/        .::.`.-:://+-                                 #    
#                   ``-//-----------odMMMs`      -yh:/m+.-:///+-                                 #    
#               `..--------/oyy/---::/+sh.      -mNd/omh-:://++.                                 #    
#             `.-------------:------::///:.     yNMMMMNs-:///+:                                  #    
#           `------------------------:::://:`   omNNNmy-:///+:`                                  #    
#          .--------........---------:::::/+/.  `+sys/-::/+++:`                                  #    
#         .---------.---------------:::::///++:..------::://+o+.                                 #    
#        .---------...-------------:::::://++/----------:::///+o-                                #    
#        -------------------------::::::////:---.-------::::///+o.                               #    
#       `:----------------------:::::::///:---..-------:::::///+o/                               #    
#       .:--------------------:::::://///:-------------::::////+o+             `.-               #    
#       `::---------------:::::::://////:------------::::::///+++/            ..-:               #    
#       `::::--------:::::::////////////-----------::::://///++++-           .--:/`  ``..        #    
#        -/:::::::::::://///////////////--------::::://////+++++/`          .--:/+...--/.        #    
#         :///::::://////++++++++++++++/-----::::///////++++++//.         `.---::----:/:         #    
#          :+//////++++++++++++++++++o+/-:::::///////++++++++/:`         `..-------:/+/`````.`   #    
#           ./++++ooooooooooooooooooo/:::::///+++++++++++++//-`         `.---------///-..--:-    #    
#            `-+osssso/+sssssssssso+/::://+++ooooooooo+++/:-`          `----------------://-     #    
#               .:+:.` `-+ossyyyysooo++++oosssssoooo++//+:.            ---------------:/+/.      #    
#                         `-/+osyyyyyysssyysssssoo++++++oso/.----.````.-------------://+/`       #    
#                             `..-://+++osysssssooosyso+ooossydhs+----------------:://++:        #    
#                                       `+ssssssssssyyyo+++++/:--------------::::////////-`      #    
#                   `                  -+osooooooooosshhs/:----..--------::://////++//:----.     #    
#           ..`    ...`               :ssooooossssssyyy+:------------::/++ooooooooooo+/:----.`   #    
#           .--..``-.--`              .oysssssssssshdo:----------::/++ossyhddhhdo....--------`   #    
#     ``    `:-.---:----`             .----------:+mh:------:://++oohhhdddddddddms`              #    
#    `.......-:----------.`          .-...```````..smy++//++ooooooooyddddddddddddmy`             #    
#      `.-------------------.`````..-/:--.....`````.:shhhdddho/::/+oohdddddhhhhhddms             #    
#         `-------....--------------/:-...````````````..----:/.` ``-/+hddddhhhddddmd:            #    
#           `.-----.--..-----------:/:-....````````````````..::``  `.:ommddhdddmmmmms            #    
#             `---------------::://++:--......``````````....--/:`````.:sdddmmmmmdddmh`           #    
#             .--------:://+++++//:-//:--.....................-/-````.-/yydhyyyhhhhdd`           #    
#           `..----:://///:--..``   :+::--------..............-//.```.-:sdhyyyyyhhhhd`           #    
#          ..--::://::-..-://+///:-`.o/::----.................-:+:.``..:+hyyyyyyhhhhs            #    
#         .-::-..`   `:+ooooooooooso/o+:::---------------------:++-....:/yyyyyyyyhhh:            #    
#          `        .syso+++++++oooosso+/::::::-----------::::::+s/-..--:shyyyyyhhys`            #    
#                `.../yysoooooo+oooossyso///::------------::://++yo:---:/ohyyyyhhys.             #    
#                :o+:`.oysoooooooooossyhhoo+:----------:::::://++dh+::::/+dhhhhhys.              #    
#                .ooo:``ohyssoooooosssyhhoooo+:------::::::////++ymo//::/+dhhddh/`               #    
#                 /sso:``ohyyssssssssyyhdysooooo/:::://++///++++shds+////+mddho-                 #    
#                  :sss/.`odhyyyyyyyyyyhdddyssooso///+oysooooosshNhso++//+hyo-                   #    
#                   -syy+-.sdhhhyyyyyyyyyyhhhyyssssoosyyysssyhdmNdysso++/ossso+/-.               #    
#                    `/syo:-sddhhhyyyyysssyyhhhhyyyysosssssossyyhyyssso+ossoo++//-               #    
#                      `+hy/-oddhhyyyyssssyyyhddddhh+  `/oosssssssssoo+ydhho/:-.`                #    
#                       :osso:+ddhhyyyssssyyyhddhhyo.   `/oosssssssssssyhhhhhhhhy+.              #    
#                        -sso+::yddhyyyyyyyyyhho `       `:+osssssssssyhsoshdhhhhddo-`           #    
#                         .oys/--odddhhhhyyhhhs.           .:osyyyyyyhsoooyhdhyssyhds/           #    
#                          `/yy+:-/dmdddhhhhyo.             `yhhhhhysoosyhddhsoosyyds-           #    
#                            .+ys+/+dmdddhy+.               `shyssoosyhdddhysooosyhdo-`          #    
#                              .+so:-/::-.                   `-+oshhhhhhyyssoooosyhd/-           #    
#                                ``                        .:+oooo++oooooooooooosyhh-.           #    
#                                                        `+oooo++++++++++++++ooosyho`            #    
#                                                        +ssooooo++++++++++++oosyhd/.            #    
#                                                       `yyysssoooooooo+++oooosyyhh-.            #    
#                                                        sdhhyyyssssssssssssyyyhhd+-.            #    
#                                                        .hmddddhhhhhhhhhhhhhddddo:-             #    
#                                                         `:ohddmmddddddddddhyso/::              #    
#                                                            -:/++ooooooo++//:--.`               #    
##################################################################################################
#                           ____       _                                                         #
#                          / ___| __ _| | __ _ _ __   __ _  __ _  ___                            #
#                         | |  _ / _` | |/ _` | '_ \ / _` |/ _` |/ _ \                           #
#                         | |_| | (_| | | (_| | |_) | (_| | (_| | (_) |                          # 
#                     _____\____|\__,_|_|\__,_| .__/ \__,_|\__, |\___/ _                         #  
#                    |  ___| __ __ _ _ __ ___ |_|____      |___/  _ __| | _                      #_
#                    | |_ | '__/ _` | '_ ` _ \ / _ \ \ /\ / / _ \| '__| |/ /                     #
#                    |  _|| | | (_| | | | | | |  __/\ V  V / (_) | |  |   <                      # 
#                    |_|  |_|  \__,_|_| |_| |_|\___| \_/\_/ \___/|_|  |_|\_\                     #
#                                                                                                # 
##################################################################################################

import ROOT as r
from   ROOT import gROOT, TCanvas, TFile, TGraphErrors, SetOwnership
import math, sys, optparse, array, copy, os
import gc, inspect
import numpy as np
import time

import include.Sample as Sample
import include.Launcher as Launcher
import include.helper as helper
import include.Canvas as Canvas
import include.CutManager as CutManager

####################################### CLASS DEFINITION #########################################

class bcolors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'

global outtag
outtag = ''

################################# GLOBAL VARIABLES DEFINITION ####################################

WORKPATH = os.path.abspath('./') + '/'

##################################### FUNCTION DEFINITION ########################################


    
def makePlot(qeue, lumi, var, name, nbin, xmin, xmax, xlabel, logx, treeMC, cuts, treeSI = False, treeDATA = False, LLlabel = '', normed = False):

    if qeue:

        launcher = Launcher.Launcher(script = os.path.dirname(os.path.abspath(__file__)) +'/'+ __file__, ID = name, output = outtag, gridui = False)
        order = "makePlot(qeue = False, lumi = {0}, var = '{1}', name = '{2}', nbin = {3}, xmin = {4}, xmax = {5}, xlabel = '{6}', logx = {7}, treeMC = treeMC, cuts = '{8}', treeSI = treeSI, treeDATA = treeDATA, LLlabel = '{9}', normed = {10})".format(lumi, var, name, nbin, xmin, xmax, xlabel, logx, cuts, LLlabel, normed)
        launcher.addOrder(order)
        launcher.launch()
        time.sleep(1.0)
#        launcher.clear()

    else:

        hMCS = treeMC.getStack(lumi, "hMCS_%s"%(name), var, nbin, xmin, xmax, cuts, "", xlabel)
        luminosity = lumi
        backgroundCounter = 0
    
        ### MC total histogram
        f = 0
        for _i, _h in enumerate(hMCS.GetHists()):
            if not f: hMC = copy.deepcopy(_h)
            else: hMC.Add(_h, 1.)
            f = 1
            backgroundCounter+=1
    
        hMC.SetMarkerStyle(20) # Auxiliar to save the ratio correctly 
    
        ### Signal histograms
        if treeSI:
    
            hSIS = treeSI.getStack(lumi, "hMCS_%s"%(name), var, nbin, xmin, xmax, cuts, "", xlabel)
    
            s_histos = []
            for _i, _h in enumerate(hSIS.GetHists()):
                s_histos.append(copy.deepcopy(_h))
    
        """
        ### Data histogram
        if treeDATA:
    
            hDATA = treeDATA.getLoopTH1F('histDATA_'+name, regs[0] + '_' + var, xlabel)
            for i in range(1, len(regs)):
                if regs[i] == 'SR': continue # BLINDED
                hDATA.Add(treeDATA.getLoopTH1F('histDATA_'+name, regs[i] + '_' + var, xlabel))
    
            hDATA.SetMarkerStyle(20)
            hDATA.SetMarkerSize(0.8)
            #hDATA.Scale(hMC.Integral()/hDATA.Integral())
        """
    
        # Normalization
        if normed:
            hMC.Scale(1.0/hMC.Integral())
            for _h in s_histos: _h.Scale(1.0/_h.Integral())
            luminosity = 1.0
    
        ### Get maximum
        maxValMC = hMC.GetMaximum()
        maxValSI = 0 if not treeSI else max([s_histos[i].GetMaximum() for i in range(0, len(s_histos))])
        maxValDATA = 0 if not treeDATA else hDATA.GetMaximum()
        maxVal = max([maxValMC, maxValSI, maxValDATA])
    
        ### Set Maximum
        if not logx:
            hMCS.SetMaximum(1.3*maxVal)
            hMCS.SetMinimum(0.0)
            hMC.SetMaximum(1.3*maxVal)
            hMC.SetMinimum(0.0)
            if treeSI:
                for _h in s_histos: 
                    _h.SetMaximum(1.3*maxVal)
                    _h.SetMinimum(0.0)
            if treeDATA:
                hDATA.SetMaximum(1.3*maxVal)
                hDATA.SetMinimum(0.0)
        else:
            hMCS.SetMaximum(10.0*maxVal)
            hMCS.SetMinimum(0.1)
            hMC.SetMaximum(10.0*maxVal)
            hMC.SetMinimum(0.1)
            if treeSI:
                for _h in s_histos: 
                    _h.SetMaximum(10.0*maxVal)
                    _h.SetMinimum(0.1)
            if treeDATA:
                hDATA.SetMaximum(10.0*maxVal)
                hDATA.SetMinimum(0.1)
    
    
        ### Canvas object
        if treeDATA:
            plot = Canvas.Canvas('hist_'+name, 'png', 0.34, 0.68, 0.9, 0.9, 2)
        else:
            plot = Canvas.Canvas('hist_'+name, 'png', 0.6, 0.6, 0.9, 0.9, 1)
    
        if normed: plot.addHisto(hMC, 'HIST', '', 'l', r.kBlue, 1, 0) # Background
        else: plot.addStack(hMCS, 'HIST', 1, 0) # Background
    
        if treeSI:
            for i,_h in enumerate(s_histos):
                _h.SetLineWidth(2) # provisional
                plot.addHisto(_h, 'HIST, SAME', _h.GetTitle(), 'l', _h.GetFillColor(), 1, i+backgroundCounter) # Signal
    
        if treeDATA:
            plot.addHisto(hDATA, 'P, SAME', '', 'p', r.kBlack, 1, 4)
    
    
       ### Dilepton banner
        if LLlabel == 'EE':
            plot.addLatex(0.17, 0.86, 'e^{+}e^{-} channel')
        if LLlabel == 'MM':
            plot.addLatex(0.17, 0.86, '#mu^{+}#mu^{-} channel')
    
        ### Save it
        if treeDATA:
            plot.saveRatio(1, 0, logx, luminosity, hDATA, hMC, label="Data/MC", outputDir = WORKPATH + 'Plots/')
        else:
            plot.save(1, 0, logx, luminosity, '', outputDir = WORKPATH + 'Plots_'+outtag+'/')


        del plot
        return 

if __name__ == "__main__":

    print bcolors.HEADER
    print "                                 ```.....`                              "        
    print "                               `.````.-:::-.-------.                    "        
    print "                              ``      .--.`````.--://-                  "
    print "                                   `   `        `-::://`                "
    print "                                `os/y:           .-::/+/                "
    print "                                yNdod+        ````-:://+`               "
    print "                 ``-/-..------.-hNMMs`     `oy/sy.-:://+.               "
    print "              `..------:+ss/--::/+sh.     `dNh/sN/-://+/`               "
    print "           `.-------------------::///.    /NMMMNm::///+-                "
    print "         `.---------------------:::://:`  -dmNNh/:///+-                 "
    print "        `--------.---.----------:::::/+/.``-++/:-://+o+.                "
    print "       `--------..--------------:::://++/---------:://++:               "
    print "       .----------------------::::::/++:----------::://+o:              "
    print "       ---------------------::::::://:---..------:::://++o`             "
    print "      `:-------------------::::::///:----.------::::://++o.             "
    print "      `::--------------::::::://///:-----------:::::///+++.             "
    print "       ::::------:::::::://////////----------:::::////+++/`             "
    print "       ./:::::::::::///////////////-------:::://////++++/-              "
    print "        -///////////++++++++++++++/----:::///////++++++/-               "
    print "         ./+///+++++ooooooooo+ooo+::::::///++++++++++//.                "
    print "          `-+ooosssooooosssssso+/:::///+++++oooo+++//-`                 "
    print "            `-+so/-.:+sssyyysso++///+oooooooooo++//-`                   "
    print "               ``    `.:+osyyyyysssssssssssoo++++oo+:`..```             "
    print "                         `.-:/+++oooyyysssooosso+ooosoyhyo/-.           "
    print "                                  ``+sssssssssyyso++++/:------::        "
    print "                                  -+oooooooooosyhy+:----.-------::      "
    print '########################################################################' 
    print '                  Starting IFCA-LLP analysis...                         '
    print '########################################################################' + bcolors.ENDC

    parser = optparse.OptionParser(usage='usage: %prog [opts] FilenameWithSamples', version='%prog 1.0')
    parser.add_option('-o', '--out', action='store', type=str, dest='out', default='', help='Output tag')
    parser.add_option('-q', '--qeue', action='store_true', dest='qeue', help='Select if you want to send the job a qeue')
    (opts, args) = parser.parse_args()

    outtag = opts.out

    ############# Set the TDR plot style
    r.gROOT.LoadMacro(WORKPATH + 'include/tdrstyle.C+')
    r.gROOT.SetBatch(1)
    r.setTDRStyle()

    ############# Background definition
    Backgrounds = []
    Backgrounds.append('DYJetsToLL_M-50') 
    Backgrounds.append('DYJetsToLL_M-10to50') 
    Backgrounds.append('WW') 
    Backgrounds.append('WZ') 
    Backgrounds.append('ZZ') 
    Backgrounds.append('WJetsToLNu') 
    Backgrounds.append('TTJets_DiLept') 
    Backgrounds.append('QCD_Pt-30to40') 
    Backgrounds.append('QCD_Pt-40toInf') 

    ############# Signal definition
    Signals = []
    Signals.append('DisplacedSUSY_350_148_173')

    ############# Parameter definition
    lumi = 36.773 # luminosity

    ############# Tree creation
    treeMC = Sample.Tree( fileName = helper.selectSamples(WORKPATH + 'dat/Samples.dat', Backgrounds, 'MC'), name = 'MC', isdata = 0 )
    treeSI = Sample.Tree( fileName = helper.selectSamples(WORKPATH + 'dat/Samples.dat', Signals, 'SI'), name = 'SI', isdata = 0 )
    treeDATA = False

    ############# Cut definition
    cuts = CutManager.CutManager()
    EESR = cuts.AddListB([cuts.nTrack, cuts.EEChannel, cuts.haveEEBase, cuts.EESR_dPhi])
    MMSR = cuts.AddListB([cuts.nTrack, cuts.MMChannel, cuts.haveMMBase, cuts.MMSR_dPhi])


    ############# Plotting
    start_time = time.time()
    makePlot(opts.qeue, lumi, 'MMBase_trackIxy[MMBase_maxIxy]', 'SR_MMBase_trackIxy', 40, 0, 20, 'MM I_{xy}', True, treeMC, MMSR, treeSI)
    makePlot(opts.qeue, lumi, 'MMBase_refittedIxy[MMBase_maxIxy] - MMBase_trackIxy[MMBase_maxIxy]', 'SR_MMBase_IxyDiff', 50, -20, 120, 'Refitted I_{xy} - original I_{xy}', True, treeMC, MMSR, treeSI)
    makePlot(opts.qeue, lumi, 'nEEBase', 'nEEBase', 3, 0, 3, 'Number of valid EE candidates', True, treeMC, EESR, treeSI)
    makePlot(opts.qeue, lumi, 'EEBase_trackIxy[EEBase_maxIxy]', 'SR_EEBase_trackIxy', 40, 0, 20, 'EE I_{xy}', True, treeMC, EESR, treeSI)
    makePlot(opts.qeue, lumi, 'EEBase_refittedIxy[EEBase_maxIxy] - EEBase_trackIxy[EEBase_maxIxy]', 'SREEBase_IxyDiff', 50, -20, 120, 'Refitted I_{xy} - original I_{xy}', True, treeMC, EESR, treeSI)
    makePlot(opts.qeue, lumi, 'nMMBase', 'nMMBase', 3, 0, 3, 'Number of valid MM candidates', True, treeMC, MMSR, treeSI)
    print("--- %s seconds ---" % (time.time() - start_time))


