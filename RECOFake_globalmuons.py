##################################################################################################
#                                                                                                #    
#                                      ```...`                                                   #    
#                                   `......-::::.`...---.`                                       #    
#                                  ``     `.-::-.....---:::-`                                    #    
#                                           ..`      `.--:://-                                   #    
#                                     `//:`            .-:::/+:                                  #    
#                                    +m/`sy            `.-:://+`                                 #    
#                              `    :mMmdN/        .::.`.-:://+-                                 #    
#                   ``-//-----------odMMMs`      -yh:/m+.-:///+-                                 #    
#               `..--------/oyy/---::/+sh.      -mNd/omh-:://++.                                 #    
#             `.-------------:------::///:.     yNMMMMNs-:///+:                                  #    
#           `------------------------:::://:`   omNNNmy-:///+:`                                  #    
#          .--------........---------:::::/+/.  `+sys/-::/+++:`                                  #    
#         .---------.---------------:::::///++:..------::://+o+.                                 #    
#        .---------...-------------:::::://++/----------:::///+o-                                #    
#        -------------------------::::::////:---.-------::::///+o.                               #    
#       `:----------------------:::::::///:---..-------:::::///+o/                               #    
#       .:--------------------:::::://///:-------------::::////+o+             `.-               #    
#       `::---------------:::::::://////:------------::::::///+++/            ..-:               #    
#       `::::--------:::::::////////////-----------::::://///++++-           .--:/`  ``..        #    
#        -/:::::::::::://///////////////--------::::://////+++++/`          .--:/+...--/.        #    
#         :///::::://////++++++++++++++/-----::::///////++++++//.         `.---::----:/:         #    
#          :+//////++++++++++++++++++o+/-:::::///////++++++++/:`         `..-------:/+/`````.`   #    
#           ./++++ooooooooooooooooooo/:::::///+++++++++++++//-`         `.---------///-..--:-    #    
#            `-+osssso/+sssssssssso+/::://+++ooooooooo+++/:-`          `----------------://-     #    
#               .:+:.` `-+ossyyyysooo++++oosssssoooo++//+:.            ---------------:/+/.      #    
#                         `-/+osyyyyyysssyysssssoo++++++oso/.----.````.-------------://+/`       #    
#                             `..-://+++osysssssooosyso+ooossydhs+----------------:://++:        #    
#                                       `+ssssssssssyyyo+++++/:--------------::::////////-`      #    
#                   `                  -+osooooooooosshhs/:----..--------::://////++//:----.     #    
#           ..`    ...`               :ssooooossssssyyy+:------------::/++ooooooooooo+/:----.`   #    
#           .--..``-.--`              .oysssssssssshdo:----------::/++ossyhddhhdo....--------`   #    
#     ``    `:-.---:----`             .----------:+mh:------:://++oohhhdddddddddms`              #    
#    `.......-:----------.`          .-...```````..smy++//++ooooooooyddddddddddddmy`             #    
#      `.-------------------.`````..-/:--.....`````.:shhhdddho/::/+oohdddddhhhhhddms             #    
#         `-------....--------------/:-...````````````..----:/.` ``-/+hddddhhhddddmd:            #    
#           `.-----.--..-----------:/:-....````````````````..::``  `.:ommddhdddmmmmms            #    
#             `---------------::://++:--......``````````....--/:`````.:sdddmmmmmdddmh`           #    
#             .--------:://+++++//:-//:--.....................-/-````.-/yydhyyyhhhhdd`           #    
#           `..----:://///:--..``   :+::--------..............-//.```.-:sdhyyyyyhhhhd`           #    
#          ..--::://::-..-://+///:-`.o/::----.................-:+:.``..:+hyyyyyyhhhhs            #    
#         .-::-..`   `:+ooooooooooso/o+:::---------------------:++-....:/yyyyyyyyhhh:            #    
#          `        .syso+++++++oooosso+/::::::-----------::::::+s/-..--:shyyyyyhhys`            #    
#                `.../yysoooooo+oooossyso///::------------::://++yo:---:/ohyyyyhhys.             #    
#                :o+:`.oysoooooooooossyhhoo+:----------:::::://++dh+::::/+dhhhhhys.              #    
#                .ooo:``ohyssoooooosssyhhoooo+:------::::::////++ymo//::/+dhhddh/`               #    
#                 /sso:``ohyyssssssssyyhdysooooo/:::://++///++++shds+////+mddho-                 #    
#                  :sss/.`odhyyyyyyyyyyhdddyssooso///+oysooooosshNhso++//+hyo-                   #    
#                   -syy+-.sdhhhyyyyyyyyyyhhhyyssssoosyyysssyhdmNdysso++/ossso+/-.               #    
#                    `/syo:-sddhhhyyyyysssyyhhhhyyyysosssssossyyhyyssso+ossoo++//-               #    
#                      `+hy/-oddhhyyyyssssyyyhddddhh+  `/oosssssssssoo+ydhho/:-.`                #    
#                       :osso:+ddhhyyyssssyyyhddhhyo.   `/oosssssssssssyhhhhhhhhy+.              #    
#                        -sso+::yddhyyyyyyyyyhho `       `:+osssssssssyhsoshdhhhhddo-`           #    
#                         .oys/--odddhhhhyyhhhs.           .:osyyyyyyhsoooyhdhyssyhds/           #    
#                          `/yy+:-/dmdddhhhhyo.             `yhhhhhysoosyhddhsoosyyds-           #    
#                            .+ys+/+dmdddhy+.               `shyssoosyhdddhysooosyhdo-`          #    
#                              .+so:-/::-.                   `-+oshhhhhhyyssoooosyhd/-           #    
#                                ``                        .:+oooo++oooooooooooosyhh-.           #    
#                                                        `+oooo++++++++++++++ooosyho`            #    
#                                                        +ssooooo++++++++++++oosyhd/.            #    
#                                                       `yyysssoooooooo+++oooosyyhh-.            #    
#                                                        sdhhyyyssssssssssssyyyhhd+-.            #    
#                                                        .hmddddhhhhhhhhhhhhhddddo:-             #    
#                                                         `:ohddmmddddddddddhyso/::              #    
#                                                            -:/++ooooooo++//:--.`               #    
##################################################################################################
#                           ____       _                                                         #
#                          / ___| __ _| | __ _ _ __   __ _  __ _  ___                            #
#                         | |  _ / _` | |/ _` | '_ \ / _` |/ _` |/ _ \                           #
#                         | |_| | (_| | | (_| | |_) | (_| | (_| | (_) |                          # 
#                     _____\____|\__,_|_|\__,_| .__/ \__,_|\__, |\___/ _                         #  
#                    |  ___| __ __ _ _ __ ___ |_|____      |___/  _ __| | _                      #_
#                    | |_ | '__/ _` | '_ ` _ \ / _ \ \ /\ / / _ \| '__| |/ /                     #
#                    |  _|| | | (_| | | | | | |  __/\ V  V / (_) | |  |   <                      # 
#                    |_|  |_|  \__,_|_| |_| |_|\___| \_/\_/ \___/|_|  |_|\_\                     #
#                                                                                                # 
##################################################################################################

import ROOT as r
from   ROOT import gROOT, TCanvas, TFile, TGraphErrors, SetOwnership, TVector3
import math, sys, optparse, array, copy, os
import gc, inspect
import numpy as np

import include.Sample as Sample
import include.helper as helper
import include.Canvas as Canvas

####################################### CLASS DEFINITION #########################################

class bcolors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'



################################# GLOBAL VARIABLES DEFINITION ####################################

runningfile = os.path.abspath(__file__)
WORKPATH = ''
for level in runningfile.split('/')[:-1]:
    WORKPATH += level
    WORKPATH += '/'

print('runningfile: ' + runningfile)

##################################### FUNCTION DEFINITION ########################################

def makeOFHisto(h):

    """
    Function to make overflow histograms
       Parameter: Histogram
       Return:    Same histogram with an additional bin with events out of x axis
    """

    nbin = h.GetNbinsX()
    bw = h.GetBinWidth(1)
    xmin = h.GetXaxis().GetBinLowEdge(1)
    xmax = h.GetXaxis().GetBinUpEdge(nbin)
    _h = r.TH1F(h.GetName() + '_OF', '', nbin + 1, xmin, xmax + bw)

    for _bin in range(1, nbin + 2):
        _h.SetBinContent(_bin, h.GetBinContent(_bin))
        _h.SetBinError(_bin, h.GetBinError(_bin))

    _h.GetXaxis().SetTitle(h.GetXaxis().GetTitle())
    _h.GetYaxis().SetTitle(h.GetYaxis().GetTitle())

    return _h


def tuneHistograms(total, passed, failed, doOF = True):

    if doOF:
        _total = makeOFHisto(total)
        _passed = makeOFHisto(passed)
        _failed = makeOFHisto(failed)
    else:
        _total = total
        _passed = passed
        _failed = failed

    _total.Scale(1.0/_total.Integral())
    _passed.Scale(1.0/_passed.Integral())
    _failed.Scale(1.0/_failed.Integral())

    ymax = max(_total.GetMaximum(), _passed.GetMaximum(), _failed.GetMaximum())
    _total.SetMaximum(1.2*ymax)
    _passed.SetMaximum(1.2*ymax)
    _failed.SetMaximum(1.2*ymax)

    _total.SetLineWidth(2)
    _passed.SetLineWidth(2)
    _failed.SetLineWidth(2)

    return _total, _passed, _failed


##################################### MAIN CODE ########################################

if __name__ == "__main__":

    print bcolors.HEADER
    print "                                 ```.....`                              "        
    print "                               `.````.-:::-.-------.                    "        
    print "                              ``      .--.`````.--://-                  "
    print "                                   `   `        `-::://`                "
    print "                                `os/y:           .-::/+/                "
    print "                                yNdod+        ````-:://+`               "
    print "                 ``-/-..------.-hNMMs`     `oy/sy.-:://+.               "
    print "              `..------:+ss/--::/+sh.     `dNh/sN/-://+/`               "
    print "           `.-------------------::///.    /NMMMNm::///+-                "
    print "         `.---------------------:::://:`  -dmNNh/:///+-                 "
    print "        `--------.---.----------:::::/+/.``-++/:-://+o+.                "
    print "       `--------..--------------:::://++/---------:://++:               "
    print "       .----------------------::::::/++:----------::://+o:              "
    print "       ---------------------::::::://:---..------:::://++o`             "
    print "      `:-------------------::::::///:----.------::::://++o.             "
    print "      `::--------------::::::://///:-----------:::::///+++.             "
    print "       ::::------:::::::://////////----------:::::////+++/`             "
    print "       ./:::::::::::///////////////-------:::://////++++/-              "
    print "        -///////////++++++++++++++/----:::///////++++++/-               "
    print "         ./+///+++++ooooooooo+ooo+::::::///++++++++++//.                "
    print "          `-+ooosssooooosssssso+/:::///+++++oooo+++//-`                 "
    print "            `-+so/-.:+sssyyysso++///+oooooooooo++//-`                   "
    print "               ``    `.:+osyyyyysssssssssssoo++++oo+:`..```             "
    print "                         `.-:/+++oooyyysssooosso+ooosoyhyo/-.           "
    print "                                  ``+sssssssssyyso++++/:------::        "
    print "                                  -+oooooooooosyhy+:----.-------::      "
    print '########################################################################' 
    print '                  Starting IFCA-LLP analysis...                         '
    print '########################################################################' + bcolors.ENDC

    gROOT.ProcessLine('.L ' + WORKPATH + 'include/tdrstyle.C')
    gROOT.SetBatch(1)
    print('WORKPATH: ' + WORKPATH)
    r.setTDRStyle()

    ###########################
    ####   Parser object   ####
    ###########################
    parser = optparse.OptionParser(usage='usage: %prog [opts] FilenameWithSamples', version='%prog 1.0')
    parser.add_option('-n', '--maxNumber', action='store', type=int, dest='maxNumber', default=0, help='Output tag')
    parser.add_option('-t', '--tag', action='store', type=str, dest='tag', default='', help='Output tag')
    parser.add_option('-f', '--filename', action='store', type=str, dest='filename', default='', help='Path to file')
    (opts, args) = parser.parse_args()

    outputPath =  WORKPATH + 'fakes_muons/' if not opts.tag else WORKPATH + 'fakes_' + opts.tag + '/'

    ##################################
    ####   Variable declaration   ####
    ##################################
    MAX_DELTAR = 0.2 



    #################################
    ####   TEfficiency binning   ####
    #################################
    #Lxy_bin = np.array([0.0, 0.025, 0.5, 1.0, 2.0, 4.0, 8.0, 12.0, 16.0, 20., 30., 40., 50., 60., 70., 90., 110.0])
    #Lxy_bin = np.linspace(0.0, 110.0, 51)
    #pt_bin = np.linspace(0.0, 300.0, 60)
    pt_bin = np.concatenate((np.linspace(0, 125, 15), np.array([150, 175, 200, 250, 300, 400, 500])))
    eta_bin = np.linspace(-2.5, 2.5, 21)
    nvalid_bin = np.linspace(0, 90, 31)
    normChi2_bin = np.linspace(0, 15, 31)
    #dxy_bin = np.linspace(0, 30, 31)
    dxy_bin = np.array([0.0, 1.0, 30.0, 100.0])
    #reliso_bin = np.logspace(-3, 2, 60)
    reliso_bin = np.linspace(0, 2, 60)

    #############################
    ####   Book Histograms   ####
    #############################

    ####
    #### DG HISTOGRAMS
    ####

    #### Total histograms:
    total_DGM_pt = r.TH1F("total_DGM_pt", ";Reconstructed #mu p_{T} (GeV);Muons", len(pt_bin)-1, pt_bin)
    total_DGM_eta = r.TH1F("total_DGM_eta", ";Reconstructed #mu #eta;Muons", len(eta_bin)-1, eta_bin)
    total_DGM_numberOfValidHits = r.TH1F("total_DGM_numberOfValidHits", ";Number of valid hits;Muons", len(nvalid_bin)-1, nvalid_bin)
    total_DGM_normChi2 = r.TH1F("total_DGM_normChi2", ";Muon #chi^{2};Muons", len(normChi2_bin)-1, normChi2_bin)
    total_DGM_reliso = r.TH1F("total_DGM_reliso", ";Muon relative isolation (GeV);Muons", len(reliso_bin)-1, reliso_bin)
    total_DGM_dxy = r.TH1F("total_DGM_dxy", ";Reconstructed d_{xy} (cm);Muons", len(dxy_bin)-1, dxy_bin)

    #### Total histograms (bin1):
    total_DGM_pt_bin1 = r.TH1F("total_DGM_pt_bin1", ";Reconstructed #mu p_{T} (GeV);Muons", len(pt_bin)-1, pt_bin)
    total_DGM_eta_bin1 = r.TH1F("total_DGM_eta_bin1", ";Reconstructed #mu #eta;Muons", len(eta_bin)-1, eta_bin)
    total_DGM_numberOfValidHits_bin1 = r.TH1F("total_DGM_numberOfValidHits_bin1", ";Number of valid hits;Muons", len(nvalid_bin)-1, nvalid_bin)
    total_DGM_normChi2_bin1 = r.TH1F("total_DGM_normChi2_bin1", ";Muon #chi^{2};Muons", len(normChi2_bin)-1, normChi2_bin)
    total_DGM_reliso_bin1 = r.TH1F("total_DGM_reliso_bin1", ";Muon relative isolation (GeV);Muons", len(reliso_bin)-1, reliso_bin)

    #### Total histograms (bin2):
    total_DGM_pt_bin2 = r.TH1F("total_DGM_pt_bin2", ";Reconstructed #mu p_{T} (GeV);Muons", len(pt_bin)-1, pt_bin)
    total_DGM_eta_bin2 = r.TH1F("total_DGM_eta_bin2", ";Reconstructed #mu #eta;Muons", len(eta_bin)-1, eta_bin)
    total_DGM_numberOfValidHits_bin2 = r.TH1F("total_DGM_numberOfValidHits_bin2", ";Number of valid hits;Muons", len(nvalid_bin)-1, nvalid_bin)
    total_DGM_normChi2_bin2 = r.TH1F("total_DGM_normChi2_bin2", ";Muon #chi^{2};Muons", len(normChi2_bin)-1, normChi2_bin)
    total_DGM_reliso_bin2 = r.TH1F("total_DGM_reliso_bin2", ";Muon relative isolation (GeV);Muons", len(reliso_bin)-1, reliso_bin)

    #### Total histograms (bin3):
    total_DGM_pt_bin3 = r.TH1F("total_DGM_pt_bin3", ";Reconstructed #mu p_{T} (GeV);Muons", len(pt_bin)-1, pt_bin)
    total_DGM_eta_bin3 = r.TH1F("total_DGM_eta_bin3", ";Reconstructed #mu #eta;Muons", len(eta_bin)-1, eta_bin)
    total_DGM_numberOfValidHits_bin3 = r.TH1F("total_DGM_numberOfValidHits_bin3", ";Number of valid hits;Muons", len(nvalid_bin)-1, nvalid_bin)
    total_DGM_normChi2_bin3 = r.TH1F("total_DGM_normChi2_bin3", ";Muon #chi^{2};Muons", len(normChi2_bin)-1, normChi2_bin)
    total_DGM_reliso_bin3 = r.TH1F("total_DGM_reliso_bin3", ";Muon relative isolation (GeV);Muons", len(reliso_bin)-1, reliso_bin)



    #### Matched histograms:
    matched_DGM_pt = r.TH1F("matched_DGM_pt", ";Reconstructed #mu p_{T} (GeV);Muons", len(pt_bin)-1, pt_bin)
    matched_DGM_eta = r.TH1F("matched_DGM_eta", ";Reconstructed #mu #eta;Muons", len(eta_bin)-1, eta_bin)
    matched_DGM_numberOfValidHits = r.TH1F("matched_DGM_numberOfValidHits", ";Number of valid hits;Muons", len(nvalid_bin)-1, nvalid_bin)
    matched_DGM_normChi2 = r.TH1F("matched_DGM_normChi2", ";Muon #chi^{2};Muons", len(normChi2_bin)-1, normChi2_bin)
    matched_DGM_reliso = r.TH1F("matched_DGM_reliso", ";Muon relative isolation (GeV);Muons", len(reliso_bin)-1, reliso_bin)
    matched_DGM_dxy = r.TH1F("matched_DGM_dxy", ";Reconstructed d_{xy} (cm);Muons", len(dxy_bin)-1, dxy_bin)


    #### Matched histograms (bin1):
    matched_DGM_pt_bin1 = r.TH1F("matched_DGM_pt_bin1", ";Reconstructed #mu p_{T} (GeV);Muons", len(pt_bin)-1, pt_bin)
    matched_DGM_eta_bin1 = r.TH1F("matched_DGM_eta_bin1", ";Reconstructed #mu #eta;Muons", len(eta_bin)-1, eta_bin)
    matched_DGM_numberOfValidHits_bin1 = r.TH1F("matched_DGM_numberOfValidHits_bin1", ";Number of valid hits;Muons", len(nvalid_bin)-1, nvalid_bin)
    matched_DGM_normChi2_bin1 = r.TH1F("matched_DGM_normChi2_bin1", ";Muon #chi^{2};Muons", len(normChi2_bin)-1, normChi2_bin)
    matched_DGM_reliso_bin1 = r.TH1F("matched_DGM_reliso_bin1", ";Muon relative isolation (GeV);Muons", len(reliso_bin)-1, reliso_bin)

    #### Matched histograms (bin2):
    matched_DGM_pt_bin2 = r.TH1F("matched_DGM_pt_bin2", ";Reconstructed #mu p_{T} (GeV);Muons", len(pt_bin)-1, pt_bin)
    matched_DGM_eta_bin2 = r.TH1F("matched_DGM_eta_bin2", ";Reconstructed #mu #eta;Muons", len(eta_bin)-1, eta_bin)
    matched_DGM_numberOfValidHits_bin2 = r.TH1F("matched_DGM_numberOfValidHits_bin2", ";Number of valid hits;Muons", len(nvalid_bin)-1, nvalid_bin)
    matched_DGM_normChi2_bin2 = r.TH1F("matched_DGM_normChi2_bin2", ";Muon #chi^{2};Muons", len(normChi2_bin)-1, normChi2_bin)
    matched_DGM_reliso_bin2 = r.TH1F("matched_DGM_reliso_bin2", ";Muon relative isolation (GeV);Muons", len(reliso_bin)-1, reliso_bin)

    #### Matched histograms (bin3):
    matched_DGM_pt_bin3 = r.TH1F("matched_DGM_pt_bin3", ";Reconstructed #mu p_{T} (GeV);Muons", len(pt_bin)-1, pt_bin)
    matched_DGM_eta_bin3 = r.TH1F("matched_DGM_eta_bin3", ";Reconstructed #mu #eta;Muons", len(eta_bin)-1, eta_bin)
    matched_DGM_numberOfValidHits_bin3 = r.TH1F("matched_DGM_numberOfValidHits_bin3", ";Number of valid hits;Muons", len(nvalid_bin)-1, nvalid_bin)
    matched_DGM_normChi2_bin3 = r.TH1F("matched_DGM_normChi2_bin3", ";Muon #chi^{2};Muons", len(normChi2_bin)-1, normChi2_bin)
    matched_DGM_reliso_bin3 = r.TH1F("matched_DGM_reliso_bin3", ";Muon relative isolation (GeV);Muons", len(reliso_bin)-1, reliso_bin)


    #### Unmatched histograms
    unmatched_DGM_pt = r.TH1F("unmatched_DGM_pt", ";Reconstructed #mu p_{T} (GeV);Muons", len(pt_bin)-1, pt_bin)
    unmatched_DGM_eta = r.TH1F("unmatched_DGM_eta", ";Reconstructed #mu #eta;Muons", len(eta_bin)-1, eta_bin)
    unmatched_DGM_numberOfValidHits = r.TH1F("unmatched_DGM_numberOfValidHits", ";Number of valid hits;Muons", len(nvalid_bin)-1, nvalid_bin)
    unmatched_DGM_normChi2 = r.TH1F("unmatched_DGM_normChi2", ";Muon #chi^{2};Muons", len(normChi2_bin)-1, normChi2_bin)
    unmatched_DGM_reliso = r.TH1F("unmatched_DGM_reliso", ";Muon relative isolation (GeV);Muons", len(reliso_bin)-1, reliso_bin)
    unmatched_DGM_dxy = r.TH1F("unmatched_DGM_dxy", ";Reconstructed d_{xy} (cm);Muons", len(dxy_bin)-1, dxy_bin)

    #### Unmatched histograms (bin1):
    unmatched_DGM_pt_bin1 = r.TH1F("unmatched_DGM_pt_bin1", ";Reconstructed #mu p_{T} (GeV);Muons", len(pt_bin)-1, pt_bin)
    unmatched_DGM_eta_bin1 = r.TH1F("unmatched_DGM_eta_bin1", ";Reconstructed #mu #eta;Muons", len(eta_bin)-1, eta_bin)
    unmatched_DGM_numberOfValidHits_bin1 = r.TH1F("unmatched_DGM_numberOfValidHits_bin1", ";Number of valid hits;Muons", len(nvalid_bin)-1, nvalid_bin)
    unmatched_DGM_normChi2_bin1 = r.TH1F("unmatched_DGM_normChi2_bin1", ";Muon #chi^{2};Muons", len(normChi2_bin)-1, normChi2_bin)
    unmatched_DGM_reliso_bin1 = r.TH1F("unmatched_DGM_reliso_bin1", ";Muon relative isolation (GeV);Muons", len(reliso_bin)-1, reliso_bin)

    #### Unmatched histograms (bin2):
    unmatched_DGM_pt_bin2 = r.TH1F("unmatched_DGM_pt_bin2", ";Reconstructed #mu p_{T} (GeV);Muons", len(pt_bin)-1, pt_bin)
    unmatched_DGM_eta_bin2 = r.TH1F("unmatched_DGM_eta_bin2", ";Reconstructed #mu #eta;Muons", len(eta_bin)-1, eta_bin)
    unmatched_DGM_numberOfValidHits_bin2 = r.TH1F("unmatched_DGM_numberOfValidHits_bin2", ";Number of valid hits;Muons", len(nvalid_bin)-1, nvalid_bin)
    unmatched_DGM_normChi2_bin2 = r.TH1F("unmatched_DGM_normChi2_bin2", ";Muon #chi^{2};Muons", len(normChi2_bin)-1, normChi2_bin)
    unmatched_DGM_reliso_bin2 = r.TH1F("unmatched_DGM_reliso_bin2", ";Muon relative isolation (GeV);Muons", len(reliso_bin)-1, reliso_bin)

    #### Unmatched histograms (bin3):
    unmatched_DGM_pt_bin3 = r.TH1F("unmatched_DGM_pt_bin3", ";Reconstructed #mu p_{T} (GeV);Muons", len(pt_bin)-1, pt_bin)
    unmatched_DGM_eta_bin3 = r.TH1F("unmatched_DGM_eta_bin3", ";Reconstructed #mu #eta;Muons", len(eta_bin)-1, eta_bin)
    unmatched_DGM_numberOfValidHits_bin3 = r.TH1F("unmatched_DGM_numberOfValidHits_bin3", ";Number of valid hits;Muons", len(nvalid_bin)-1, nvalid_bin)
    unmatched_DGM_normChi2_bin3 = r.TH1F("unmatched_DGM_normChi2_bin3", ";Muon #chi^{2};Muons", len(normChi2_bin)-1, normChi2_bin)
    unmatched_DGM_reliso_bin3 = r.TH1F("unmatched_DGM_reliso_bin3", ";Muon relative isolation (GeV);Muons", len(reliso_bin)-1, reliso_bin)


    ####
    #### PATGlobal HISTOGRAMS
    ####

    #### Total histograms:
    total_PATGlobal_pt = r.TH1F("total_PATGlobal_pt", ";Reconstructed #mu p_{T} (GeV);Muons", len(pt_bin)-1, pt_bin)
    total_PATGlobal_eta = r.TH1F("total_PATGlobal_eta", ";Reconstructed #mu #eta;Muons", len(eta_bin)-1, eta_bin)
    total_PATGlobal_reliso = r.TH1F("total_PATGlobal_reliso", ";Muon relative isolation (GeV);Muons", len(reliso_bin)-1, reliso_bin)
    total_PATGlobal_dxy = r.TH1F("total_PATGlobal_dxy", ";Reconstructed d_{xy} (cm);Muons", len(dxy_bin)-1, dxy_bin)

    #### Matched histograms:
    matched_PATGlobal_pt = r.TH1F("matched_PATGlobal_pt", ";Reconstructed #mu p_{T} (GeV);Muons", len(pt_bin)-1, pt_bin)
    matched_PATGlobal_eta = r.TH1F("matched_PATGlobal_eta", ";Reconstructed #mu #eta;Muons", len(eta_bin)-1, eta_bin)
    matched_PATGlobal_reliso = r.TH1F("matched_PATGlobal_reliso", ";Muon relative isolation (GeV);Muons", len(reliso_bin)-1, reliso_bin)
    matched_PATGlobal_dxy = r.TH1F("matched_PATGlobal_dxy", ";Reconstructed d_{xy} (cm);Muons", len(dxy_bin)-1, dxy_bin)

    #### Unmatched histograms
    unmatched_PATGlobal_pt = r.TH1F("unmatched_PATGlobal_pt", ";Reconstructed #mu p_{T} (GeV);Muons", len(pt_bin)-1, pt_bin)
    unmatched_PATGlobal_eta = r.TH1F("unmatched_PATGlobal_eta", ";Reconstructed #mu #eta;Muons", len(eta_bin)-1, eta_bin)
    unmatched_PATGlobal_reliso = r.TH1F("unmatched_PATGlobal_reliso", ";Muon relative isolation (GeV);Muons", len(reliso_bin)-1, reliso_bin)
    unmatched_PATGlobal_dxy = r.TH1F("unmatched_PATGlobal_dxy", ";Reconstructed d_{xy} (cm);Muons", len(dxy_bin)-1, dxy_bin)

    
    ####
    #### PATMedium HISTOGRAMS
    ####

    #### Total histograms:
    total_PATMedium_pt = r.TH1F("total_PATMedium_pt", ";Reconstructed #mu p_{T} (GeV);Muons", len(pt_bin)-1, pt_bin)
    total_PATMedium_eta = r.TH1F("total_PATMedium_eta", ";Reconstructed #mu #eta;Muons", len(eta_bin)-1, eta_bin)
    total_PATMedium_reliso = r.TH1F("total_PATMedium_reliso", ";Muon relative isolation (GeV);Muons", len(reliso_bin)-1, reliso_bin)
    total_PATMedium_dxy = r.TH1F("total_PATMedium_dxy", ";Reconstructed d_{xy} (cm);Muons", len(dxy_bin)-1, dxy_bin)

    #### Matched histograms:
    matched_PATMedium_pt = r.TH1F("matched_PATMedium_pt", ";Reconstructed #mu p_{T} (GeV);Muons", len(pt_bin)-1, pt_bin)
    matched_PATMedium_eta = r.TH1F("matched_PATMedium_eta", ";Reconstructed #mu #eta;Muons", len(eta_bin)-1, eta_bin)
    matched_PATMedium_reliso = r.TH1F("matched_PATMedium_reliso", ";Muon relative isolation (GeV);Muons", len(reliso_bin)-1, reliso_bin)
    matched_PATMedium_dxy = r.TH1F("matched_PATMedium_dxy", ";Reconstructed d_{xy} (cm);Muons", len(dxy_bin)-1, dxy_bin)

    #### Unmatched histograms
    unmatched_PATMedium_pt = r.TH1F("unmatched_PATMedium_pt", ";Reconstructed #mu p_{T} (GeV);Muons", len(pt_bin)-1, pt_bin)
    unmatched_PATMedium_eta = r.TH1F("unmatched_PATMedium_eta", ";Reconstructed #mu #eta;Muons", len(eta_bin)-1, eta_bin)
    unmatched_PATMedium_reliso = r.TH1F("unmatched_PATMedium_reliso", ";Muon relative isolation (GeV);Muons", len(reliso_bin)-1, reliso_bin)
    unmatched_PATMedium_dxy = r.TH1F("unmatched_PATMedium_dxy", ";Reconstructed d_{xy} (cm);Muons", len(dxy_bin)-1, dxy_bin)
    



    #########################
    ####   Load sample   ####
    #########################
    """
    _sampleName = opts.filename
    _file = TFile(_sampleName)
    _tree = _file.Get("Events")
    print("TTree with " + str(_tree.GetEntries()) + " entries")
    """

    _sampleNames = (opts.filename).split(',')
    _tree = r.TChain('Events')
    for _name in _sampleNames:
        _tree.Add(_name)

    print("TTree with " + str(_tree.GetEntries()) + " entries")

    ###################################
    ####   Loop over tree events   ####
    ###################################

    for i in range(0, _tree.GetEntries()):

        _tree.GetEntry(i)
        if opts.maxNumber:
            if i > opts.maxNumber: break

        ### Muon Channel
        #if _tree.Flag_HLT_L2DoubleMu28_NoVertex_2Cha_Angle2p5_Mass10 == 1:
        if True:

            ###############
            ## DGM muons ##
            ###############
            for j in range(0, _tree.nDGM):
                #if abs(_tree.DGM_eta[j]) > 2: continue
                #if _tree.DGM_pt[j] < 31: continue

                pt       = _tree.DGM_pt[j]
                eta      = _tree.DGM_eta[j]
                phi      = _tree.DGM_phi[j]
                dxy      = _tree.DGM_dxy[j]
                nvalid   = _tree.DGM_numberOfValidHits[j]
                chi2     = _tree.DGM_chi2[j]
                ndof     = _tree.DGM_ndof[j]
                normChi2 = float(chi2)/float(ndof)
                reliso   = _tree.DGM_relPFiso[j]

                l = TVector3()
                l.SetPtEtaPhi(pt, eta, phi)

                total_DGM_pt.Fill(pt)
                total_DGM_eta.Fill(eta)
                total_DGM_dxy.Fill(dxy)
                total_DGM_numberOfValidHits.Fill(nvalid)
                total_DGM_normChi2.Fill(float(chi2)/float(ndof))
                total_DGM_reliso.Fill(reliso)

                if dxy < dxy_bin[1]:
                    total_DGM_pt_bin1.Fill(pt)
                    total_DGM_eta_bin1.Fill(eta)
                    total_DGM_numberOfValidHits_bin1.Fill(nvalid)
                    total_DGM_normChi2_bin1.Fill(float(chi2)/float(ndof))
                    total_DGM_reliso_bin1.Fill(reliso)
                elif dxy > dxy_bin[1] and dxy < dxy_bin[2]:
                    total_DGM_pt_bin2.Fill(pt)
                    total_DGM_eta_bin2.Fill(eta)
                    total_DGM_numberOfValidHits_bin2.Fill(nvalid)
                    total_DGM_normChi2_bin2.Fill(float(chi2)/float(ndof))
                    total_DGM_reliso_bin2.Fill(reliso)
                else:
                    total_DGM_pt_bin3.Fill(pt)
                    total_DGM_eta_bin3.Fill(eta)
                    total_DGM_numberOfValidHits_bin3.Fill(nvalid)
                    total_DGM_normChi2_bin3.Fill(float(chi2)/float(ndof))
                    total_DGM_reliso_bin3.Fill(reliso)



                deltaR = 9999.0
                index = -9
                for k in range(0, _tree.nGenLepton):
                    if abs(_tree.GenLeptonSel_pdgId[k]) != 13: continue
                    #if not _tree.GenLeptonSel_isPromptFinalState[k]: continue

                    re = TVector3()
                    re.SetPtEtaPhi(_tree.GenLeptonSel_pt[k], _tree.GenLeptonSel_eta[k], _tree.GenLeptonSel_phi[k])
                    if re.DeltaR(l) < deltaR:
                        deltaR = re.DeltaR(l)
                        index = k

                if deltaR < MAX_DELTAR:
                    matched_DGM_pt.Fill(pt)
                    matched_DGM_eta.Fill(eta)
                    matched_DGM_dxy.Fill(dxy)
                    matched_DGM_numberOfValidHits.Fill(nvalid)
                    matched_DGM_normChi2.Fill(float(chi2)/float(ndof))
                    matched_DGM_reliso.Fill(reliso)

                    if dxy < dxy_bin[1]:
                        matched_DGM_pt_bin1.Fill(pt)
                        matched_DGM_eta_bin1.Fill(eta)
                        matched_DGM_numberOfValidHits_bin1.Fill(nvalid)
                        matched_DGM_normChi2_bin1.Fill(float(chi2)/float(ndof))
                        matched_DGM_reliso_bin1.Fill(reliso)
                    elif dxy > dxy_bin[1] and dxy < dxy_bin[2]:
                        matched_DGM_pt_bin2.Fill(pt)
                        matched_DGM_eta_bin2.Fill(eta)
                        matched_DGM_numberOfValidHits_bin2.Fill(nvalid)
                        matched_DGM_normChi2_bin2.Fill(float(chi2)/float(ndof))
                        matched_DGM_reliso_bin2.Fill(reliso)
                    else:
                        matched_DGM_pt_bin3.Fill(pt)
                        matched_DGM_eta_bin3.Fill(eta)
                        matched_DGM_numberOfValidHits_bin3.Fill(nvalid)
                        matched_DGM_normChi2_bin3.Fill(float(chi2)/float(ndof))
                        matched_DGM_reliso_bin3.Fill(reliso)
                else:
                    unmatched_DGM_pt.Fill(pt)
                    unmatched_DGM_eta.Fill(eta)
                    unmatched_DGM_dxy.Fill(dxy)
                    unmatched_DGM_numberOfValidHits.Fill(nvalid)
                    unmatched_DGM_normChi2.Fill(float(chi2)/float(ndof))
                    unmatched_DGM_reliso.Fill(reliso)

                    if dxy < dxy_bin[1]:
                        unmatched_DGM_pt_bin1.Fill(pt)
                        unmatched_DGM_eta_bin1.Fill(eta)
                        unmatched_DGM_numberOfValidHits_bin1.Fill(nvalid)
                        unmatched_DGM_normChi2_bin1.Fill(float(chi2)/float(ndof))
                        unmatched_DGM_reliso_bin1.Fill(reliso)
                    elif dxy > dxy_bin[1] and dxy < dxy_bin[2]:
                        unmatched_DGM_pt_bin2.Fill(pt)
                        unmatched_DGM_eta_bin2.Fill(eta)
                        unmatched_DGM_numberOfValidHits_bin2.Fill(nvalid)
                        unmatched_DGM_normChi2_bin2.Fill(float(chi2)/float(ndof))
                        unmatched_DGM_reliso_bin2.Fill(reliso)
                    else:
                        unmatched_DGM_pt_bin3.Fill(pt)
                        unmatched_DGM_eta_bin3.Fill(eta)
                        unmatched_DGM_numberOfValidHits_bin3.Fill(nvalid)
                        unmatched_DGM_normChi2_bin3.Fill(float(chi2)/float(ndof))
                        unmatched_DGM_reliso_bin3.Fill(reliso)

            ###############
            ## PAT muons ##
            ###############
            for j in range(_tree.nMuon):

                pt       = _tree.MuonSel_pt[j]
                eta      = _tree.MuonSel_eta[j]
                phi      = _tree.MuonSel_phi[j]
                dxy      = _tree.MuonSel_dB[j]
                reliso   = _tree.MuonSel_relIso[j]

                if _tree.MuonSel_pt[j] < 20: continue


                l = TVector3()
                l.SetPtEtaPhi(pt, eta, phi)

                ### Matching to generation: 
                deltaR = 9999.0
                index = -9
                for k in range(0, _tree.nGenLepton):
                    if abs(_tree.GenLeptonSel_pdgId[k]) != 13: continue

                    re = TVector3()
                    re.SetPtEtaPhi(_tree.GenLeptonSel_pt[k], _tree.GenLeptonSel_eta[k], _tree.GenLeptonSel_phi[k])
                    if re.DeltaR(l) < deltaR:
                        deltaR = re.DeltaR(l)
                        index = k


                ### -> PAT Global case:
                if _tree.MuonSel_isGlobalMuon[j]:

                    total_PATGlobal_pt.Fill(pt)
                    total_PATGlobal_eta.Fill(eta)
                    total_PATGlobal_dxy.Fill(dxy)
                    total_PATGlobal_reliso.Fill(reliso)

                    if deltaR < MAX_DELTAR:
                        matched_PATGlobal_pt.Fill(pt)
                        matched_PATGlobal_eta.Fill(eta)
                        matched_PATGlobal_dxy.Fill(dxy)
                        matched_PATGlobal_reliso.Fill(reliso)
                    else:
                        unmatched_PATGlobal_pt.Fill(pt)
                        unmatched_PATGlobal_eta.Fill(eta)
                        unmatched_PATGlobal_dxy.Fill(dxy)
                        unmatched_PATGlobal_reliso.Fill(reliso)


                ### -> PAT Medium case:
                if _tree.MuonSel_isGlobalMuon[j] and _tree.MuonSel_isMediumMuon[j]: ### PAT Global + Medium case

                    total_PATMedium_pt.Fill(pt)
                    total_PATMedium_eta.Fill(eta)
                    total_PATMedium_dxy.Fill(dxy)
                    total_PATMedium_reliso.Fill(reliso)
            
                    if deltaR < MAX_DELTAR:
                        matched_PATMedium_pt.Fill(pt)
                        matched_PATMedium_eta.Fill(eta)
                        matched_PATMedium_dxy.Fill(dxy)
                        matched_PATMedium_reliso.Fill(reliso)
                    else:
                        unmatched_PATMedium_pt.Fill(pt)
                        unmatched_PATMedium_eta.Fill(eta)
                        unmatched_PATMedium_dxy.Fill(dxy)
                        unmatched_PATMedium_reliso.Fill(reliso)



    #### Define Fake rates
    fake_DGM_pt = r.TEfficiency(unmatched_DGM_pt, total_DGM_pt)
    fake_DGM_eta = r.TEfficiency(unmatched_DGM_eta, total_DGM_eta)
    fake_DGM_numberOfValidHits = r.TEfficiency(unmatched_DGM_numberOfValidHits, total_DGM_numberOfValidHits)
    fake_DGM_normChi2 = r.TEfficiency(unmatched_DGM_normChi2, total_DGM_normChi2)
    fake_DGM_reliso = r.TEfficiency(unmatched_DGM_reliso, total_DGM_reliso)

    fake_DGM_pt_bin1 = r.TEfficiency(unmatched_DGM_pt_bin1, total_DGM_pt_bin1)
    fake_DGM_eta_bin1 = r.TEfficiency(unmatched_DGM_eta_bin1, total_DGM_eta_bin1)
    fake_DGM_numberOfValidHits_bin1 = r.TEfficiency(unmatched_DGM_numberOfValidHits_bin1, total_DGM_numberOfValidHits_bin1)
    fake_DGM_normChi2_bin1 = r.TEfficiency(unmatched_DGM_normChi2_bin1, total_DGM_normChi2_bin1)
    fake_DGM_reliso_bin1 = r.TEfficiency(unmatched_DGM_reliso_bin1, total_DGM_reliso_bin1)

    fake_DGM_pt_bin2 = r.TEfficiency(unmatched_DGM_pt_bin2, total_DGM_pt_bin2)
    fake_DGM_eta_bin2 = r.TEfficiency(unmatched_DGM_eta_bin2, total_DGM_eta_bin2)
    fake_DGM_numberOfValidHits_bin2 = r.TEfficiency(unmatched_DGM_numberOfValidHits_bin2, total_DGM_numberOfValidHits_bin2)
    fake_DGM_normChi2_bin2 = r.TEfficiency(unmatched_DGM_normChi2_bin2, total_DGM_normChi2_bin2)
    fake_DGM_reliso_bin2 = r.TEfficiency(unmatched_DGM_reliso_bin2, total_DGM_reliso_bin2)

    fake_DGM_pt_bin3 = r.TEfficiency(unmatched_DGM_pt_bin3, total_DGM_pt_bin3)
    fake_DGM_eta_bin3 = r.TEfficiency(unmatched_DGM_eta_bin3, total_DGM_eta_bin3)
    fake_DGM_numberOfValidHits_bin3 = r.TEfficiency(unmatched_DGM_numberOfValidHits_bin3, total_DGM_numberOfValidHits_bin3)
    fake_DGM_normChi2_bin3 = r.TEfficiency(unmatched_DGM_normChi2_bin3, total_DGM_normChi2_bin3)
    fake_DGM_reliso_bin3 = r.TEfficiency(unmatched_DGM_reliso_bin3, total_DGM_reliso_bin3)

    fake_DGM_dxy = r.TEfficiency(unmatched_DGM_dxy, total_DGM_dxy)

    fake_PATGlobal_pt = r.TEfficiency(unmatched_PATGlobal_pt, total_PATGlobal_pt)
    fake_PATGlobal_eta = r.TEfficiency(unmatched_PATGlobal_eta, total_PATGlobal_eta)
    fake_PATGlobal_dxy = r.TEfficiency(unmatched_PATGlobal_dxy, total_PATGlobal_dxy)
    fake_PATGlobal_reliso = r.TEfficiency(unmatched_PATGlobal_reliso, total_PATGlobal_reliso)

    fake_PATMedium_pt = r.TEfficiency(unmatched_PATMedium_pt, total_PATMedium_pt)
    fake_PATMedium_eta = r.TEfficiency(unmatched_PATMedium_eta, total_PATMedium_eta)
    fake_PATMedium_dxy = r.TEfficiency(unmatched_PATMedium_dxy, total_PATMedium_dxy)
    fake_PATMedium_reliso = r.TEfficiency(unmatched_PATMedium_reliso, total_PATMedium_reliso)

    #### Write everything to a file:

    if not os.path.exists(WORKPATH + 'fakes_'+opts.tag+'/'): os.makedirs(WORKPATH + 'fakes_'+opts.tag+'/')
    outputFile = TFile(WORKPATH +'fakes_'+ opts.tag + '/MuonFakes.root', 'RECREATE')

    total_DGM_pt.Write()
    total_DGM_eta.Write()
    total_DGM_dxy.Write()
    total_DGM_numberOfValidHits.Write()
    total_DGM_normChi2.Write()
    total_DGM_reliso.Write()

    total_DGM_pt_bin1.Write()
    total_DGM_eta_bin1.Write()
    total_DGM_numberOfValidHits_bin1.Write()
    total_DGM_normChi2_bin1.Write()
    total_DGM_reliso_bin1.Write()

    total_DGM_pt_bin2.Write()
    total_DGM_eta_bin2.Write()
    total_DGM_numberOfValidHits_bin2.Write()
    total_DGM_normChi2_bin2.Write()
    total_DGM_reliso_bin2.Write()

    total_DGM_pt_bin3.Write()
    total_DGM_eta_bin3.Write()
    total_DGM_numberOfValidHits_bin3.Write()
    total_DGM_normChi2_bin3.Write()
    total_DGM_reliso_bin3.Write()

    matched_DGM_pt.Write()
    matched_DGM_eta.Write()
    matched_DGM_dxy.Write()
    matched_DGM_numberOfValidHits.Write()
    matched_DGM_normChi2.Write()
    matched_DGM_reliso.Write()

    matched_DGM_pt_bin1.Write()
    matched_DGM_eta_bin1.Write()
    matched_DGM_numberOfValidHits_bin1.Write()
    matched_DGM_normChi2_bin1.Write()
    matched_DGM_reliso_bin1.Write()

    matched_DGM_pt_bin2.Write()
    matched_DGM_eta_bin2.Write()
    matched_DGM_numberOfValidHits_bin2.Write()
    matched_DGM_normChi2_bin2.Write()
    matched_DGM_reliso_bin2.Write()

    matched_DGM_pt_bin3.Write()
    matched_DGM_eta_bin3.Write()
    matched_DGM_numberOfValidHits_bin3.Write()
    matched_DGM_normChi2_bin3.Write()
    matched_DGM_reliso_bin3.Write()

    unmatched_DGM_pt.Write()
    unmatched_DGM_eta.Write()
    unmatched_DGM_dxy.Write()
    unmatched_DGM_numberOfValidHits.Write()
    unmatched_DGM_normChi2.Write()
    unmatched_DGM_reliso.Write()

    unmatched_DGM_pt_bin1.Write()
    unmatched_DGM_eta_bin1.Write()
    unmatched_DGM_numberOfValidHits_bin1.Write()
    unmatched_DGM_normChi2_bin1.Write()
    unmatched_DGM_reliso_bin1.Write()

    unmatched_DGM_pt_bin2.Write()
    unmatched_DGM_eta_bin2.Write()
    unmatched_DGM_numberOfValidHits_bin2.Write()
    unmatched_DGM_normChi2_bin2.Write()
    unmatched_DGM_reliso_bin2.Write()

    unmatched_DGM_pt_bin3.Write()
    unmatched_DGM_eta_bin3.Write()
    unmatched_DGM_numberOfValidHits_bin3.Write()
    unmatched_DGM_normChi2_bin3.Write()
    unmatched_DGM_reliso_bin3.Write()

    fake_DGM_pt.Write()
    fake_DGM_eta.Write()
    fake_DGM_numberOfValidHits.Write()
    fake_DGM_normChi2.Write()
    fake_DGM_reliso.Write()
    fake_DGM_dxy.Write()

    fake_DGM_pt_bin1.Write()
    fake_DGM_eta_bin1.Write()
    fake_DGM_numberOfValidHits_bin1.Write()
    fake_DGM_normChi2_bin1.Write()
    fake_DGM_reliso_bin1.Write()
    fake_DGM_pt_bin2.Write()
    fake_DGM_eta_bin2.Write()
    fake_DGM_numberOfValidHits_bin2.Write()
    fake_DGM_normChi2_bin2.Write()
    fake_DGM_reliso_bin2.Write()
    fake_DGM_pt_bin3.Write()
    fake_DGM_eta_bin3.Write()
    fake_DGM_numberOfValidHits_bin3.Write()
    fake_DGM_normChi2_bin3.Write()
    fake_DGM_reliso_bin3.Write()

    outputFile.Close()

    #### Plot some of the efficiencies:

    """
    EFF_algoVSLxy = Canvas.Canvas('EFF_algoVSLxy', 'png', 0.15, 0.15, 0.40, 0.30, 1)
    EFF_algoVSLxy.addRate(eff_PATGlobal_Lxy, 'AP, same', 'PAT Global', 'p', r.kBlue-7, True, 0, marker = 21)
    EFF_algoVSLxy.save(1, 0, 0, '', '', outputDir = WORKPATH + 'efficiencies_'+opts.tag+'/', xlog = False)
    """
    total_pt, matched_pt, unmatched_pt = tuneHistograms(total_DGM_pt, matched_DGM_pt, unmatched_DGM_pt, doOF = False)
    HIST_pt = Canvas.Canvas('Hist_pt', 'png', 0.5, 0.8, 0.9, 0.89, 1)
    HIST_pt.addHisto(total_pt, 'HIST', 'Total ['+str(total_DGM_pt.GetEntries())+']', 'l', r.kBlack, 1, 0)
    HIST_pt.addHisto(matched_pt, 'HIST, same', 'Matched ['+str(matched_DGM_pt.GetEntries())+']', 'l', r.kGreen+1, 1, 1)
    HIST_pt.addHisto(unmatched_pt, 'HIST, same', 'Fakes ['+str(unmatched_DGM_pt.GetEntries())+']', 'l', r.kRed+1, 1, 2)
    HIST_pt.save(1, 0, 0, '', '', outputDir = outputPath)

    FAKE_pt = Canvas.Canvas('Fake_DGM_pt', 'png', 0.15, 0.15, 0.40, 0.30, 1)
    FAKE_pt.addRate(fake_DGM_pt, 'AP', 'PAT Global', 'p', r.kBlack, True, 0, marker = 24)
    FAKE_pt.save(0, 0, 0, '', '', outputDir = outputPath, xlog = False)

    FAKE_pt_combined = Canvas.Canvas('Fake_pt_combined', 'png', 0.6, 0.79, 0.89, 0.89, 1)
    FAKE_pt_combined.addRate(fake_DGM_pt, 'AP', 'Displaced Global', 'p', r.kBlack, True, 0, marker = 24)
    FAKE_pt_combined.addRate(fake_PATGlobal_pt, 'AP, same', 'PAT Global', 'p', r.kBlue-7, True, 1, marker = 24)
    FAKE_pt_combined.addRate(fake_PATMedium_pt, 'AP, same', 'PAT Medium', 'p', r.kRed-7, True, 2, marker = 24)
    FAKE_pt_combined.save(1, 0, 1, '', '', outputDir = outputPath, xlog = False)

    FAKE_pt = Canvas.Canvas('Fake_DGM_pt_bin', 'png', 0.6, 0.75, 0.89, 0.89, 1)
    FAKE_pt.addRate(fake_DGM_pt_bin1, 'AP', 'Prompt', 'p', r.kBlack, True, 0, marker = 24)
    FAKE_pt.addRate(fake_DGM_pt_bin2, 'AP, same', 'Low displacement', 'p', r.kRed, True, 1, marker = 24)
    FAKE_pt.addRate(fake_DGM_pt_bin3, 'AP, same', 'High displacement', 'p', r.kBlue, True, 2, marker = 24)
    FAKE_pt.save(1, 0, 1, '', '', outputDir = outputPath, xlog = False)


    total_eta, matched_eta, unmatched_eta = tuneHistograms(total_DGM_eta, matched_DGM_eta, unmatched_DGM_eta)
    HIST_eta = Canvas.Canvas('Hist_eta', 'png', 0.5, 0.8, 0.9, 0.89, 1)
    HIST_eta.addHisto(total_eta, 'HIST', 'Total ['+str(total_DGM_eta.GetEntries())+']', 'l', r.kBlack, 1, 0)
    HIST_eta.addHisto(matched_eta, 'HIST, same', 'Matched ['+str(matched_DGM_eta.GetEntries())+']', 'l', r.kGreen+1, 1, 1)
    HIST_eta.addHisto(unmatched_eta, 'HIST, same', 'Fakes ['+str(unmatched_DGM_eta.GetEntries())+']', 'l', r.kRed+1, 1, 2)
    HIST_eta.save(1, 0, 0, '', '', outputDir = outputPath)

    FAKE_eta_combined = Canvas.Canvas('Fake_eta_combined', 'png', 0.6, 0.79, 0.89, 0.89, 1)
    FAKE_eta_combined.addRate(fake_DGM_eta, 'AP', 'Displaced Global', 'p', r.kBlack, True, 0, marker = 24)
    FAKE_eta_combined.addRate(fake_PATGlobal_eta, 'AP, same', 'PAT Global', 'p', r.kBlue-7, True, 1, marker = 24)
    FAKE_eta_combined.addRate(fake_PATMedium_eta, 'AP, same', 'PAT Medium', 'p', r.kRed-7, True, 2, marker = 24)
    FAKE_eta_combined.save(1, 0, 1, '', '', outputDir = outputPath, xlog = False)


    FAKE_eta = Canvas.Canvas('Fake_DGM_eta', 'png', 0.15, 0.15, 0.40, 0.30, 1)
    FAKE_eta.addRate(fake_DGM_eta, 'AP', 'PAT Global', 'p', r.kBlack, True, 0, marker = 24)
    FAKE_eta.save(0, 0, 1, '', '', outputDir = outputPath, xlog = False)

    FAKE_eta = Canvas.Canvas('Fake_DGM_eta_bin', 'png', 0.6, 0.75, 0.89, 0.89, 1)
    FAKE_eta.addRate(fake_DGM_eta_bin1, 'AP', 'Prompt', 'p', r.kBlack, True, 0, marker = 24)
    FAKE_eta.addRate(fake_DGM_eta_bin2, 'AP, same', 'Low displacement', 'p', r.kRed, True, 1, marker = 24)
    FAKE_eta.addRate(fake_DGM_eta_bin3, 'AP, same', 'High displacement', 'p', r.kBlue, True, 2, marker = 24)
    FAKE_eta.save(1, 0, 1, '', '', outputDir = outputPath, xlog = False)

    total_dxy, matched_dxy, unmatched_dxy = tuneHistograms(total_DGM_dxy, matched_DGM_dxy, unmatched_DGM_dxy, doOF = False)
    HIST_dxy = Canvas.Canvas('Hist_dxy', 'png', 0.5, 0.8, 0.9, 0.89, 1)
    HIST_dxy.addHisto(total_dxy, 'HIST', 'Total ['+str(total_DGM_dxy.GetEntries())+']', 'l', r.kBlack, 1, 0)
    HIST_dxy.addHisto(matched_dxy, 'HIST, same', 'Matched ['+str(matched_DGM_dxy.GetEntries())+']', 'l', r.kGreen+1, 1, 1)
    HIST_dxy.addHisto(unmatched_dxy, 'HIST, same', 'Fakes ['+str(unmatched_DGM_dxy.GetEntries())+']', 'l', r.kRed+1, 1, 2)
    HIST_dxy.save(1, 0, 0, '', '', outputDir = outputPath)


    FAKE_dxy = Canvas.Canvas('Fake_DGM_dxy', 'png', 0.15, 0.15, 0.40, 0.30, 1)
    FAKE_dxy.addRate(fake_DGM_dxy, 'AP', 'PAT Global', 'p', r.kBlack, True, 0, marker = 24)
    FAKE_dxy.save(0, 0, 1, '', '', outputDir = outputPath, xlog = False)


    FAKE_dxy_combined = Canvas.Canvas('Fake_dxy_combined', 'png', 0.6, 0.19, 0.89, 0.39, 1)
    FAKE_dxy_combined.addRate(fake_DGM_dxy, 'AP', 'Displaced Global', 'p', r.kBlack, True, 0, marker = 24)
    FAKE_dxy_combined.addRate(fake_PATGlobal_dxy, 'AP, same', 'PAT Global', 'p', r.kBlue-7, True, 1, marker = 24)
    FAKE_dxy_combined.addRate(fake_PATMedium_dxy, 'AP, same', 'PAT Medium', 'p', r.kRed-7, True, 2, marker = 24)
    FAKE_dxy_combined.save(1, 0, 1, '', '', outputDir = outputPath, xlog = False)


    total_numberOfValidHits, matched_numberOfValidHits, unmatched_numberOfValidHits = tuneHistograms(total_DGM_numberOfValidHits, matched_DGM_numberOfValidHits, unmatched_DGM_numberOfValidHits)
    HIST_numberOfValidHits = Canvas.Canvas('Hist_numberOfValidHits', 'png', 0.5, 0.8, 0.9, 0.89, 1)
    HIST_numberOfValidHits.addHisto(total_numberOfValidHits, 'HIST', 'Total ['+str(total_DGM_numberOfValidHits.GetEntries())+']', 'l', r.kBlack, 1, 0)
    HIST_numberOfValidHits.addHisto(matched_numberOfValidHits, 'HIST, same', 'Matched ['+str(matched_DGM_numberOfValidHits.GetEntries())+']', 'l', r.kGreen+1, 1, 1)
    HIST_numberOfValidHits.addHisto(unmatched_numberOfValidHits, 'HIST, same', 'Fakes ['+str(unmatched_DGM_numberOfValidHits.GetEntries())+']', 'l', r.kRed+1, 1, 2)
    HIST_numberOfValidHits.save(1, 0, 0, '', '', outputDir = outputPath)

    FAKE_numberOfValidHits = Canvas.Canvas('Fake_DGM_numberOfValidHits', 'png', 0.15, 0.15, 0.40, 0.30, 1)
    FAKE_numberOfValidHits.addRate(fake_DGM_numberOfValidHits, 'AP', 'PAT Global', 'p', r.kBlack, True, 0, marker = 24)
    FAKE_numberOfValidHits.save(0, 0, 0, '', '', outputDir = outputPath, xlog = False)

    FAKE_numberOfValidHits = Canvas.Canvas('Fake_DGM_numberOfValidHits_bin', 'png', 0.6, 0.75, 0.89, 0.89, 1)
    FAKE_numberOfValidHits.addRate(fake_DGM_numberOfValidHits_bin1, 'AP', 'Prompt', 'p', r.kBlack, True, 0, marker = 24)
    FAKE_numberOfValidHits.addRate(fake_DGM_numberOfValidHits_bin2, 'AP, same', 'Low displacement', 'p', r.kRed, True, 1, marker = 24)
    FAKE_numberOfValidHits.addRate(fake_DGM_numberOfValidHits_bin3, 'AP, same', 'High displacement', 'p', r.kBlue, True, 2, marker = 24)
    FAKE_numberOfValidHits.save(1, 0, 0, '', '', outputDir = outputPath, xlog = False)

    total_normChi2, matched_normChi2, unmatched_normChi2 = tuneHistograms(total_DGM_normChi2, matched_DGM_normChi2, unmatched_DGM_normChi2)
    HIST_normChi2 = Canvas.Canvas('Hist_normChi2', 'png', 0.5, 0.8, 0.9, 0.89, 1)
    HIST_normChi2.addHisto(total_normChi2, 'HIST', 'Total ['+str(total_DGM_normChi2.GetEntries())+']', 'l', r.kBlack, 1, 0)
    HIST_normChi2.addHisto(matched_normChi2, 'HIST, same', 'Matched ['+str(matched_DGM_normChi2.GetEntries())+']', 'l', r.kGreen+1, 1, 1)
    HIST_normChi2.addHisto(unmatched_normChi2, 'HIST, same', 'Fakes ['+str(unmatched_DGM_normChi2.GetEntries())+']', 'l', r.kRed+1, 1, 2)
    HIST_normChi2.save(1, 0, 0, '', '', outputDir = outputPath)

    FAKE_normChi2 = Canvas.Canvas('Fake_DGM_normChi2', 'png', 0.15, 0.15, 0.40, 0.30, 1)
    FAKE_normChi2.addRate(fake_DGM_normChi2, 'AP', 'PAT Global', 'p', r.kBlack, True, 0, marker = 24)
    FAKE_normChi2.save(0, 0, 1, '', '', outputDir = outputPath, xlog = False)

    FAKE_normChi2 = Canvas.Canvas('Fake_DGM_normChi2_bin', 'png', 0.6, 0.75, 0.89, 0.89, 1)
    FAKE_normChi2.addRate(fake_DGM_normChi2_bin1, 'AP', 'Prompt', 'p', r.kBlack, True, 0, marker = 24)
    FAKE_normChi2.addRate(fake_DGM_normChi2_bin2, 'AP, same', 'Low displacement', 'p', r.kRed, True, 1, marker = 24)
    FAKE_normChi2.addRate(fake_DGM_normChi2_bin3, 'AP, same', 'High displacement', 'p', r.kBlue, True, 2, marker = 24)
    FAKE_normChi2.save(1, 0, 1, '', '', outputDir = outputPath, xlog = False)

    total_DGM_reliso, matched_DGM_reliso, unmatched_DGM_reliso = tuneHistograms(total_DGM_reliso, matched_DGM_reliso, unmatched_DGM_reliso)
    #total_DGM_reliso.Scale(1.0/total_DGM_reliso.Integral())
    #matched_DGM_reliso.Scale(1.0/matched_DGM_reliso.Integral())
    #unmatched_DGM_reliso.Scale(1.0/unmatched_DGM_reliso.Integral())
    HIST_reliso = Canvas.Canvas('Hist_reliso', 'png', 0.5, 0.8, 0.9, 0.89, 1)
    HIST_reliso.addHisto(total_DGM_reliso, 'HIST', 'Total ['+str(total_DGM_reliso.GetEntries())+']', 'l', r.kBlack, 1, 0)
    HIST_reliso.addHisto(matched_DGM_reliso, 'HIST, same', 'Matched ['+str(matched_DGM_reliso.GetEntries())+']', 'l', r.kGreen+1, 1, 1)
    HIST_reliso.addHisto(unmatched_DGM_reliso, 'HIST, same', 'Fakes ['+str(unmatched_DGM_reliso.GetEntries())+']', 'l', r.kRed+1, 1, 2)
    HIST_reliso.save(1, 0, 0, '', '', outputDir = outputPath, xlog = False)

    FAKE_reliso = Canvas.Canvas('Fake_DGM_reliso', 'png', 0.15, 0.15, 0.40, 0.30, 1)
    FAKE_reliso.addRate(fake_DGM_reliso, 'AP', 'PAT Global', 'p', r.kBlack, True, 0, marker = 24)
    FAKE_reliso.save(0, 0, 1, '', '', outputDir = outputPath, xlog = False)

    FAKE_reliso = Canvas.Canvas('Fake_DGM_reliso_bin', 'png', 0.6, 0.75, 0.89, 0.89, 1)
    FAKE_reliso.addRate(fake_DGM_reliso_bin1, 'AP', 'Prompt', 'p', r.kBlack, True, 0, marker = 24)
    FAKE_reliso.addRate(fake_DGM_reliso_bin2, 'AP, same', 'Low displacement', 'p', r.kRed, True, 1, marker = 24)
    FAKE_reliso.addRate(fake_DGM_reliso_bin3, 'AP, same', 'High displacement', 'p', r.kBlue, True, 2, marker = 24)
    FAKE_reliso.save(1, 0, 0, '', '', outputDir = outputPath, xlog = False)


