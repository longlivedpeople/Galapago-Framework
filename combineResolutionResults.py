##################################################################################################
#                                                                                                #    
#                                      ```...`                                                   #    
#                                   `......-::::.`...---.`                                       #    
#                                  ``     `.-::-.....---:::-`                                    #    
#                                           ..`      `.--:://-                                   #    
#                                     `//:`            .-:::/+:                                  #    
#                                    +m/`sy            `.-:://+`                                 #    
#                              `    :mMmdN/        .::.`.-:://+-                                 #    
#                   ``-//-----------odMMMs`      -yh:/m+.-:///+-                                 #    
#               `..--------/oyy/---::/+sh.      -mNd/omh-:://++.                                 #    
#             `.-------------:------::///:.     yNMMMMNs-:///+:                                  #    
#           `------------------------:::://:`   omNNNmy-:///+:`                                  #    
#          .--------........---------:::::/+/.  `+sys/-::/+++:`                                  #    
#         .---------.---------------:::::///++:..------::://+o+.                                 #    
#        .---------...-------------:::::://++/----------:::///+o-                                #    
#        -------------------------::::::////:---.-------::::///+o.                               #    
#       `:----------------------:::::::///:---..-------:::::///+o/                               #    
#       .:--------------------:::::://///:-------------::::////+o+             `.-               #    
#       `::---------------:::::::://////:------------::::::///+++/            ..-:               #    
#       `::::--------:::::::////////////-----------::::://///++++-           .--:/`  ``..        #    
#        -/:::::::::::://///////////////--------::::://////+++++/`          .--:/+...--/.        #    
#         :///::::://////++++++++++++++/-----::::///////++++++//.         `.---::----:/:         #    
#          :+//////++++++++++++++++++o+/-:::::///////++++++++/:`         `..-------:/+/`````.`   #    
#           ./++++ooooooooooooooooooo/:::::///+++++++++++++//-`         `.---------///-..--:-    #    
#            `-+osssso/+sssssssssso+/::://+++ooooooooo+++/:-`          `----------------://-     #    
#               .:+:.` `-+ossyyyysooo++++oosssssoooo++//+:.            ---------------:/+/.      #    
#                         `-/+osyyyyyysssyysssssoo++++++oso/.----.````.-------------://+/`       #    
#                             `..-://+++osysssssooosyso+ooossydhs+----------------:://++:        #    
#                                       `+ssssssssssyyyo+++++/:--------------::::////////-`      #    
#                   `                  -+osooooooooosshhs/:----..--------::://////++//:----.     #    
#           ..`    ...`               :ssooooossssssyyy+:------------::/++ooooooooooo+/:----.`   #    
#           .--..``-.--`              .oysssssssssshdo:----------::/++ossyhddhhdo....--------`   #    
#     ``    `:-.---:----`             .----------:+mh:------:://++oohhhdddddddddms`              #    
#    `.......-:----------.`          .-...```````..smy++//++ooooooooyddddddddddddmy`             #    
#      `.-------------------.`````..-/:--.....`````.:shhhdddho/::/+oohdddddhhhhhddms             #    
#         `-------....--------------/:-...````````````..----:/.` ``-/+hddddhhhddddmd:            #    
#           `.-----.--..-----------:/:-....````````````````..::``  `.:ommddhdddmmmmms            #    
#             `---------------::://++:--......``````````....--/:`````.:sdddmmmmmdddmh`           #    
#             .--------:://+++++//:-//:--.....................-/-````.-/yydhyyyhhhhdd`           #    
#           `..----:://///:--..``   :+::--------..............-//.```.-:sdhyyyyyhhhhd`           #    
#          ..--::://::-..-://+///:-`.o/::----.................-:+:.``..:+hyyyyyyhhhhs            #    
#         .-::-..`   `:+ooooooooooso/o+:::---------------------:++-....:/yyyyyyyyhhh:            #    
#          `        .syso+++++++oooosso+/::::::-----------::::::+s/-..--:shyyyyyhhys`            #    
#                `.../yysoooooo+oooossyso///::------------::://++yo:---:/ohyyyyhhys.             #    
#                :o+:`.oysoooooooooossyhhoo+:----------:::::://++dh+::::/+dhhhhhys.              #    
#                .ooo:``ohyssoooooosssyhhoooo+:------::::::////++ymo//::/+dhhddh/`               #    
#                 /sso:``ohyyssssssssyyhdysooooo/:::://++///++++shds+////+mddho-                 #    
#                  :sss/.`odhyyyyyyyyyyhdddyssooso///+oysooooosshNhso++//+hyo-                   #    
#                   -syy+-.sdhhhyyyyyyyyyyhhhyyssssoosyyysssyhdmNdysso++/ossso+/-.               #    
#                    `/syo:-sddhhhyyyyysssyyhhhhyyyysosssssossyyhyyssso+ossoo++//-               #    
#                      `+hy/-oddhhyyyyssssyyyhddddhh+  `/oosssssssssoo+ydhho/:-.`                #    
#                       :osso:+ddhhyyyssssyyyhddhhyo.   `/oosssssssssssyhhhhhhhhy+.              #    
#                        -sso+::yddhyyyyyyyyyhho `       `:+osssssssssyhsoshdhhhhddo-`           #    
#                         .oys/--odddhhhhyyhhhs.           .:osyyyyyyhsoooyhdhyssyhds/           #    
#                          `/yy+:-/dmdddhhhhyo.             `yhhhhhysoosyhddhsoosyyds-           #    
#                            .+ys+/+dmdddhy+.               `shyssoosyhdddhysooosyhdo-`          #    
#                              .+so:-/::-.                   `-+oshhhhhhyyssoooosyhd/-           #    
#                                ``                        .:+oooo++oooooooooooosyhh-.           #    
#                                                        `+oooo++++++++++++++ooosyho`            #    
#                                                        +ssooooo++++++++++++oosyhd/.            #    
#                                                       `yyysssoooooooo+++oooosyyhh-.            #    
#                                                        sdhhyyyssssssssssssyyyhhd+-.            #    
#                                                        .hmddddhhhhhhhhhhhhhddddo:-             #    
#                                                         `:ohddmmddddddddddhyso/::              #    
#                                                            -:/++ooooooo++//:--.`               #    
##################################################################################################
#                           ____       _                                                         #
#                          / ___| __ _| | __ _ _ __   __ _  __ _  ___                            #
#                         | |  _ / _` | |/ _` | '_ \ / _` |/ _` |/ _ \                           #
#                         | |_| | (_| | | (_| | |_) | (_| | (_| | (_) |                          # 
#                     _____\____|\__,_|_|\__,_| .__/ \__,_|\__, |\___/ _                         #  
#                    |  ___| __ __ _ _ __ ___ |_|____      |___/  _ __| | _                      #_
#                    | |_ | '__/ _` | '_ ` _ \ / _ \ \ /\ / / _ \| '__| |/ /                     #
#                    |  _|| | | (_| | | | | | |  __/\ V  V / (_) | |  |   <                      # 
#                    |_|  |_|  \__,_|_| |_| |_|\___| \_/\_/ \___/|_|  |_|\_\                     #
#                                                                                                # 
##################################################################################################

import ROOT as r
from   ROOT import gROOT, TCanvas, TFile, TGraphErrors, SetOwnership
import math, sys, optparse, array, copy, os
import gc, inspect, __main__
import numpy as np
import time

import include.Sample as Sample
import include.Launcher as Launcher
import include.helper as helper
import include.Canvas as Canvas
import include.CutManager as CutManager
from include.Utils import *

####################################### CLASS DEFINITION #########################################

class bcolors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'



def combineProfiles(profileList, key = ''):


    # Create axis:
    axis = []
    axis.append(profileList[0].GetXaxis().GetBinLowEdge(1))
    for i in range(1, profileList[0].GetNbinsX() +1):
        axis.append(profileList[0].GetXaxis().GetBinUpEdge(i))

    hist = r.TH1F('aux' + key, '', len(axis)-1, np.array(axis))
    hist.GetXaxis().SetTitle(profileList[0].GetXaxis().GetTitle())
    hist.GetYaxis().SetTitle(profileList[0].GetYaxis().GetTitle())

    for i in range(1, hist.GetNbinsX()+1):

        h12 = 0.0
        E12 = 0.0
        s12 = 0.0
        e12 = 0.0
        nhsum = 0.0
        nT = 0.0

        for j in range(0, len(profileList)):

            _p = profileList[j]
            nj = float(_p.GetBinEntries(i))
            hj = float(_p.GetBinContent(i))
            sj = math.sqrt(nj)*_p.GetBinError(i)

            nT = nT + nj
            nhsum = nhsum + nj*hj
            E12 = E12 + nj*(sj**2 + hj**2)


        h12 = nhsum/nT
        s12 = math.sqrt(E12/nT - h12**2)
        e12 = s12/math.sqrt(nT)


        hist.SetBinContent(i, h12)
        hist.SetBinError(i, e12)

    return hist

################################# GLOBAL VARIABLES DEFINITION ####################################

runningfile = os.path.abspath(__file__)
WORKPATH = ''
for level in runningfile.split('/')[:-1]: 
    WORKPATH += level
    WORKPATH += '/'

if __name__ == "__main__":

    print bcolors.HEADER
    print "                                 ```.....`                              "        
    print "                               `.````.-:::-.-------.                    "        
    print "                              ``      .--.`````.--://-                  "
    print "                                   `   `        `-::://`                "
    print "                                `os/y:           .-::/+/                "
    print "                                yNdod+        ````-:://+`               "
    print "                 ``-/-..------.-hNMMs`     `oy/sy.-:://+.               "
    print "              `..------:+ss/--::/+sh.     `dNh/sN/-://+/`               "
    print "           `.-------------------::///.    /NMMMNm::///+-                "
    print "         `.---------------------:::://:`  -dmNNh/:///+-                 "
    print "        `--------.---.----------:::::/+/.``-++/:-://+o+.                "
    print "       `--------..--------------:::://++/---------:://++:               "
    print "       .----------------------::::::/++:----------::://+o:              "
    print "       ---------------------::::::://:---..------:::://++o`             "
    print "      `:-------------------::::::///:----.------::::://++o.             "
    print "      `::--------------::::::://///:-----------:::::///+++.             "
    print "       ::::------:::::::://////////----------:::::////+++/`             "
    print "       ./:::::::::::///////////////-------:::://////++++/-              "
    print "        -///////////++++++++++++++/----:::///////++++++/-               "
    print "         ./+///+++++ooooooooo+ooo+::::::///++++++++++//.                "
    print "          `-+ooosssooooosssssso+/:::///+++++oooo+++//-`                 "
    print "            `-+so/-.:+sssyyysso++///+oooooooooo++//-`                   "
    print "               ``    `.:+osyyyyysssssssssssoo++++oo+:`..```             "
    print "                         `.-:/+++oooyyysssooosso+ooosoyhyo/-.           "
    print "                                  ``+sssssssssyyso++++/:------::        "
    print "                                  -+oooooooooosyhy+:----.-------::      "
    print '########################################################################' 
    print '                  Starting IFCA-LLP analysis...                         '
    print '########################################################################' + bcolors.ENDC

    parser = optparse.OptionParser(usage='usage: %prog [opts] FilenameWithSamples', version='%prog 1.0')
    parser.add_option('-n', '--name', action='store', type=str, dest='name', help='Output name')
    parser.add_option('-v', '--var', action='store', type=str, dest='var', help='Input file')
    (opts, args) = parser.parse_args()


    ############# Set the TDR plot style
    r.gROOT.LoadMacro(WORKPATH + 'include/tdrstyle.C+')
    r.gROOT.SetBatch(1)
    r.setTDRStyle()
    #r.gStyle.SetErrorX(0)


    ############# Files:
    H400_X50_files = ['efficiencies_global_400_50_400/MuonEfficiencies.root']
#                      'efficiencies_global_400_50_40/MuonEfficiencies.root',
#                      'efficiencies_global_400_50_400/MuonEfficiencies.root']
    H1000_X150_files = ['efficiencies_global_1000_150_10/MuonEfficiencies.root',
                        'efficiencies_global_1000_150_100/MuonEfficiencies.root']
    H1000_X350_files = ['efficiencies_global_1000_350_35/MuonEfficiencies.root',
                        'efficiencies_global_1000_350_350/MuonEfficiencies.root']


    ftotals = [H400_X50_files, H1000_X150_files, H1000_X350_files]    


    ############## Labels
    Labels = []
    Labels.append(r.TLatex(0.16, 0.79,'H#rightarrowXX#rightarrowll:  m_{H} = 400 GeV, m_{X} = 50 GeV'))
    Labels.append(r.TLatex(0.16, 0.79,'H#rightarrowXX#rightarrowll:  m_{H} = 1000 GeV, m_{X} = 150 GeV'))
    Labels.append(r.TLatex(0.16, 0.79,'H#rightarrowXX#rightarrowll:  m_{H} = 1000 GeV, m_{X} = 350 GeV'))


    ############################
    ####    PROFILE PART    ####
    ############################

    ############# Combine the profiles
    plotList = []

    for c,flist in enumerate(ftotals):
        tocombine = []
        for f in flist:
            _file = r.TFile(f)
            _prof = _file.Get('prof_DGM_'+opts.var)
            tocombine.append(copy.deepcopy(_prof))
            _file.Close()
        plotList.append(combineProfiles(tocombine, str(c)))
         



    ############# Plot in canvas
    c1 = r.TCanvas()
    padb = r.TPad('bottom', 'bottom', 0, 0, 1, 0.1)
    padb.Draw()
    padm = r.TPad('medium', 'medium', 0, 0.1, 1, 0.90)
    padm.Draw()
    padt = r.TPad('top','top',0, 0.92, 1, 1)
    padt.Draw()

    padb.cd()
    Xaxis = r.TLatex(0.5, 0.7, plotList[0].GetXaxis().GetTitle())
    Xaxis.SetNDC()
    Xaxis.SetTextAlign(22)
    Xaxis.SetTextSize(0.35)
    Xaxis.SetTextFont(42)
    Xaxis.Draw()

    padm.Divide(1,3)
    for c,plot in enumerate(plotList):
        padm.cd(c+1)
        plot.SetMinimum(0.97)
        plot.SetMaximum(1.03)
        plot.GetXaxis().SetTitle('')
        plot.GetYaxis().SetTitle('')
        plot.GetYaxis().SetLabelSize(0.1)
        if c < len(plotList) -1:
            plot.GetXaxis().SetLabelSize(0)
        else:
            plot.GetXaxis().SetLabelSize(0.1)
        if not c: plot.Draw('p')
        else: plot.Draw('p,same')
       
        Labels[c].SetNDC()
        Labels[c].SetTextSize(0.09)
        Labels[c].SetTextFont(42)
        Labels[c].Draw()

    
    padm.cd(2)
    if opts.var == 'dxyRes': Yaxis = r.TLatex(0.03, 0.5, 'd_{xy}^{reco}/d_{xy}^{gen}')
    if opts.var == 'ptRes': Yaxis = r.TLatex(0.03, 0.5, 'p_{T}^{reco}/p_{T}^{gen}')
    Yaxis.SetNDC()
    Yaxis.SetTextAlign(22)
    Yaxis.SetTextSize(0.15)
    Yaxis.SetTextFont(42)
    Yaxis.SetTextAngle(90)
    Yaxis.Draw()

    ############ Banner 
    padt.cd()
    CMS = r.TLatex(0.13, 0.1, '#bf{CMS}')
    CMS.SetNDC()
    CMS.SetTextFont(42)
    CMS.SetTextSize(0.8)
    CMS.Draw()

    simulation = r.TLatex(0.27, 0.1, '#it{Simulation}')
    simulation.SetNDC()
    simulation.SetTextFont(42)
    simulation.SetTextSize(0.45)
    simulation.Draw()
     
    c1.SaveAs('displacedGlobal_'+opts.var+'_vsLxy.png')


    ##############################
    ####    HISTOGRAM PART    ####
    ##############################

    
    ############# Combine the histograms
    histList = []

    for c,flist in enumerate(ftotals):
        for j,f in enumerate(flist):
            _file = r.TFile(f)
            _prehist1 = copy.deepcopy(_file.Get('hist_DGM_'+opts.var+'_bin1'))
            _prehist2 = copy.deepcopy(_file.Get('hist_DGM_'+opts.var+'_bin2'))
            _prehist3 = copy.deepcopy(_file.Get('hist_DGM_'+opts.var+'_bin3'))
            if not j:
                _hist1 = _prehist1
                _hist2 = _prehist2
                _hist3 = _prehist3
            else:
                _hist1.Add(_prehist1)
                _hist2.Add(_prehist2)
                _hist3.Add(_prehist3)

            _hist1.Scale(1.0/_hist1.Integral())
            _hist2.Scale(1.0/_hist2.Integral())
            _hist3.Scale(1.0/_hist3.Integral())

            _hist1.SetLineWidth(2)
            _hist2.SetLineWidth(2)
            _hist3.SetLineWidth(2)

            maxValue = max(_hist1.GetMaximum(), _hist2.GetMaximum(), _hist3.GetMaximum())
            _hist1.SetMaximum(1.2*maxValue)

            _file.Close()

        """
        HIST =  Canvas.Canvas('binned_'+opts.var+'_'+str(c), 'png', 0.6, 0.77, 0.9, 0.89, 1)
        HIST.addHisto(_hist1, 'hist', 'L_{xy} < 5 (cm)', 'l', r.kGreen+2, 1, 0)
        HIST.addHisto(_hist2, 'hist, same', '5 < L_{xy} < 30 (cm)', 'l', r.kBlue+2, 1, 1)
        HIST.addHisto(_hist3, 'hist, same', '30 > L_{xy} (cm)', 'l', r.kRed+2, 1, 2)
        HIST.save(1, 0, 0, '', '')
        """

        histList.append([_hist1, _hist2, _hist3])

    
    ##### Plot histograms
    for c,histSet in enumerate(histList):
         HIST =  Canvas.Canvas('binned_'+opts.var+'_'+str(c), 'png', 0.6, 0.77, 0.9, 0.89, 1)
         HIST.addHisto(histSet[0], 'hist', 'L_{xy} < 5 (cm)', 'l', r.kGreen+2, 1, 0)
         HIST.addHisto(histSet[1], 'hist, same', '5 < L_{xy} < 30 (cm)', 'l', r.kBlue+2, 1, 1)
         HIST.addHisto(histSet[2], 'hist, same', '30 > L_{xy} (cm)', 'l', r.kRed+2, 1, 2)
         HIST.save(1, 0, 0, '', '')
    


