##################################################################################################
#                                                                                                #    
#                                      ```...`                                                   #    
#                                   `......-::::.`...---.`                                       #    
#                                  ``     `.-::-.....---:::-`                                    #    
#                                           ..`      `.--:://-                                   #    
#                                     `//:`            .-:::/+:                                  #    
#                                    +m/`sy            `.-:://+`                                 #    
#                              `    :mMmdN/        .::.`.-:://+-                                 #    
#                   ``-//-----------odMMMs`      -yh:/m+.-:///+-                                 #    
#               `..--------/oyy/---::/+sh.      -mNd/omh-:://++.                                 #    
#             `.-------------:------::///:.     yNMMMMNs-:///+:                                  #    
#           `------------------------:::://:`   omNNNmy-:///+:`                                  #    
#          .--------........---------:::::/+/.  `+sys/-::/+++:`                                  #    
#         .---------.---------------:::::///++:..------::://+o+.                                 #    
#        .---------...-------------:::::://++/----------:::///+o-                                #    
#        -------------------------::::::////:---.-------::::///+o.                               #    
#       `:----------------------:::::::///:---..-------:::::///+o/                               #    
#       .:--------------------:::::://///:-------------::::////+o+             `.-               #    
#       `::---------------:::::::://////:------------::::::///+++/            ..-:               #    
#       `::::--------:::::::////////////-----------::::://///++++-           .--:/`  ``..        #    
#        -/:::::::::::://///////////////--------::::://////+++++/`          .--:/+...--/.        #    
#         :///::::://////++++++++++++++/-----::::///////++++++//.         `.---::----:/:         #    
#          :+//////++++++++++++++++++o+/-:::::///////++++++++/:`         `..-------:/+/`````.`   #    
#           ./++++ooooooooooooooooooo/:::::///+++++++++++++//-`         `.---------///-..--:-    #    
#            `-+osssso/+sssssssssso+/::://+++ooooooooo+++/:-`          `----------------://-     #    
#               .:+:.` `-+ossyyyysooo++++oosssssoooo++//+:.            ---------------:/+/.      #    
#                         `-/+osyyyyyysssyysssssoo++++++oso/.----.````.-------------://+/`       #    
#                             `..-://+++osysssssooosyso+ooossydhs+----------------:://++:        #    
#                                       `+ssssssssssyyyo+++++/:--------------::::////////-`      #    
#                   `                  -+osooooooooosshhs/:----..--------::://////++//:----.     #    
#           ..`    ...`               :ssooooossssssyyy+:------------::/++ooooooooooo+/:----.`   #    
#           .--..``-.--`              .oysssssssssshdo:----------::/++ossyhddhhdo....--------`   #    
#     ``    `:-.---:----`             .----------:+mh:------:://++oohhhdddddddddms`              #    
#    `.......-:----------.`          .-...```````..smy++//++ooooooooyddddddddddddmy`             #    
#      `.-------------------.`````..-/:--.....`````.:shhhdddho/::/+oohdddddhhhhhddms             #    
#         `-------....--------------/:-...````````````..----:/.` ``-/+hddddhhhddddmd:            #    
#           `.-----.--..-----------:/:-....````````````````..::``  `.:ommddhdddmmmmms            #    
#             `---------------::://++:--......``````````....--/:`````.:sdddmmmmmdddmh`           #    
#             .--------:://+++++//:-//:--.....................-/-````.-/yydhyyyhhhhdd`           #    
#           `..----:://///:--..``   :+::--------..............-//.```.-:sdhyyyyyhhhhd`           #    
#          ..--::://::-..-://+///:-`.o/::----.................-:+:.``..:+hyyyyyyhhhhs            #    
#         .-::-..`   `:+ooooooooooso/o+:::---------------------:++-....:/yyyyyyyyhhh:            #    
#          `        .syso+++++++oooosso+/::::::-----------::::::+s/-..--:shyyyyyhhys`            #    
#                `.../yysoooooo+oooossyso///::------------::://++yo:---:/ohyyyyhhys.             #    
#                :o+:`.oysoooooooooossyhhoo+:----------:::::://++dh+::::/+dhhhhhys.              #    
#                .ooo:``ohyssoooooosssyhhoooo+:------::::::////++ymo//::/+dhhddh/`               #    
#                 /sso:``ohyyssssssssyyhdysooooo/:::://++///++++shds+////+mddho-                 #    
#                  :sss/.`odhyyyyyyyyyyhdddyssooso///+oysooooosshNhso++//+hyo-                   #    
#                   -syy+-.sdhhhyyyyyyyyyyhhhyyssssoosyyysssyhdmNdysso++/ossso+/-.               #    
#                    `/syo:-sddhhhyyyyysssyyhhhhyyyysosssssossyyhyyssso+ossoo++//-               #    
#                      `+hy/-oddhhyyyyssssyyyhddddhh+  `/oosssssssssoo+ydhho/:-.`                #    
#                       :osso:+ddhhyyyssssyyyhddhhyo.   `/oosssssssssssyhhhhhhhhy+.              #    
#                        -sso+::yddhyyyyyyyyyhho `       `:+osssssssssyhsoshdhhhhddo-`           #    
#                         .oys/--odddhhhhyyhhhs.           .:osyyyyyyhsoooyhdhyssyhds/           #    
#                          `/yy+:-/dmdddhhhhyo.             `yhhhhhysoosyhddhsoosyyds-           #    
#                            .+ys+/+dmdddhy+.               `shyssoosyhdddhysooosyhdo-`          #    
#                              .+so:-/::-.                   `-+oshhhhhhyyssoooosyhd/-           #    
#                                ``                        .:+oooo++oooooooooooosyhh-.           #    
#                                                        `+oooo++++++++++++++ooosyho`            #    
#                                                        +ssooooo++++++++++++oosyhd/.            #    
#                                                       `yyysssoooooooo+++oooosyyhh-.            #    
#                                                        sdhhyyyssssssssssssyyyhhd+-.            #    
#                                                        .hmddddhhhhhhhhhhhhhddddo:-             #    
#                                                         `:ohddmmddddddddddhyso/::              #    
#                                                            -:/++ooooooo++//:--.`               #    
##################################################################################################
#                           ____       _                                                         #
#                          / ___| __ _| | __ _ _ __   __ _  __ _  ___                            #
#                         | |  _ / _` | |/ _` | '_ \ / _` |/ _` |/ _ \                           #
#                         | |_| | (_| | | (_| | |_) | (_| | (_| | (_) |                          # 
#                     _____\____|\__,_|_|\__,_| .__/ \__,_|\__, |\___/ _                         #  
#                    |  ___| __ __ _ _ __ ___ |_|____      |___/  _ __| | _                      #_
#                    | |_ | '__/ _` | '_ ` _ \ / _ \ \ /\ / / _ \| '__| |/ /                     #
#                    |  _|| | | (_| | | | | | |  __/\ V  V / (_) | |  |   <                      # 
#                    |_|  |_|  \__,_|_| |_| |_|\___| \_/\_/ \___/|_|  |_|\_\                     #
#                                                                                                # 
##################################################################################################

import ROOT as r
from   ROOT import gROOT, TCanvas, TFile, TGraphErrors, SetOwnership, TVector3
import math, sys, optparse, array, copy, os
import gc, inspect
import numpy as np

import include.Sample as Sample
import include.helper as helper
import include.Canvas as Canvas

####################################### CLASS DEFINITION #########################################

class bcolors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'



################################# GLOBAL VARIABLES DEFINITION ####################################

runningfile = os.path.abspath(__file__)
WORKPATH = ''
for level in runningfile.split('/')[:-1]:
    WORKPATH += level
    WORKPATH += '/'

print('runningfile: ' + runningfile)

##################################### FUNCTION DEFINITION ########################################

def makeOFHisto(h):

    """
    Function to make overflow histograms
       Parameter: Histogram
       Return:    Same histogram with an additional bin with events out of x axis
    """

    nbin = h.GetNbinsX()
    bw = h.GetBinWidth(1)
    xmin = h.GetXaxis().GetBinLowEdge(1)
    xmax = h.GetXaxis().GetBinUpEdge(nbin)
    _h = r.TH1F(h.GetName() + '_OF', '', nbin + 1, xmin, xmax + bw)

    for _bin in range(1, nbin + 2):
        _h.SetBinContent(_bin, h.GetBinContent(_bin))
        _h.SetBinError(_bin, h.GetBinError(_bin))

    _h.GetXaxis().SetTitle(h.GetXaxis().GetTitle())
    _h.GetYaxis().SetTitle(h.GetYaxis().GetTitle())

    return _h

##################################### MAIN CODE ########################################

if __name__ == "__main__":

    print bcolors.HEADER
    print "                                 ```.....`                              "        
    print "                               `.````.-:::-.-------.                    "        
    print "                              ``      .--.`````.--://-                  "
    print "                                   `   `        `-::://`                "
    print "                                `os/y:           .-::/+/                "
    print "                                yNdod+        ````-:://+`               "
    print "                 ``-/-..------.-hNMMs`     `oy/sy.-:://+.               "
    print "              `..------:+ss/--::/+sh.     `dNh/sN/-://+/`               "
    print "           `.-------------------::///.    /NMMMNm::///+-                "
    print "         `.---------------------:::://:`  -dmNNh/:///+-                 "
    print "        `--------.---.----------:::::/+/.``-++/:-://+o+.                "
    print "       `--------..--------------:::://++/---------:://++:               "
    print "       .----------------------::::::/++:----------::://+o:              "
    print "       ---------------------::::::://:---..------:::://++o`             "
    print "      `:-------------------::::::///:----.------::::://++o.             "
    print "      `::--------------::::::://///:-----------:::::///+++.             "
    print "       ::::------:::::::://////////----------:::::////+++/`             "
    print "       ./:::::::::::///////////////-------:::://////++++/-              "
    print "        -///////////++++++++++++++/----:::///////++++++/-               "
    print "         ./+///+++++ooooooooo+ooo+::::::///++++++++++//.                "
    print "          `-+ooosssooooosssssso+/:::///+++++oooo+++//-`                 "
    print "            `-+so/-.:+sssyyysso++///+oooooooooo++//-`                   "
    print "               ``    `.:+osyyyyysssssssssssoo++++oo+:`..```             "
    print "                         `.-:/+++oooyyysssooosso+ooosoyhyo/-.           "
    print "                                  ``+sssssssssyyso++++/:------::        "
    print "                                  -+oooooooooosyhy+:----.-------::      "
    print '########################################################################' 
    print '                  Starting IFCA-LLP analysis...                         '
    print '########################################################################' + bcolors.ENDC

    gROOT.ProcessLine('.L ' + WORKPATH + 'include/tdrstyle.C')
    gROOT.SetBatch(1)
    r.setTDRStyle()

    ###########################
    ####   Parser object   ####
    ###########################
    parser = optparse.OptionParser(usage='usage: %prog [opts] FilenameWithSamples', version='%prog 1.0')
    parser.add_option('-n', '--maxNumber', action='store', type=int, dest='maxNumber', default=0, help='Output tag')
    parser.add_option('-t', '--tag', action='store', type=str, dest='tag', default='', help='Output tag')
    parser.add_option('-f', '--filename', action='store', type=str, dest='filename', default='', help='Path to file')
    parser.add_option('--eta1', action='store', type=float, dest='eta1', default=0.0, help='Eta1')
    parser.add_option('--eta2', action='store', type=float, dest='eta2', default=0.0, help='Eta2')
    parser.add_option('--pt1', action='store', type=float, dest='pt1', default=0.0, help='pt1')
    parser.add_option('--pt2', action='store', type=float, dest='pt2', default=0.0, help='pt2')
    parser.add_option('--Lxy', action='store', type=float, dest='Lxy', default=0.0, help='Lxy')
    (opts, args) = parser.parse_args()

    outputPath =  WORKPATH + 'TRGEff_electrons/' if not opts.tag else WORKPATH + 'TRGEff_electrons_' + opts.tag + '/'

    #################################
    ####   TEfficiency binning   ####
    #################################
    dxy_bin = np.linspace(0.0, 100.0, 51)
    Lxy_logbin = np.logspace(-2, 4.0, 51)
    dxy_bin_log = np.logspace(-2, 3.0, 51)
    #pt_bin = np.linspace(0.0, 300.0, 40)
    pt_bin = np.concatenate((np.linspace(0, 125, 15), np.array([150, 175, 200, 250, 300])))
    Lxy_bin = np.linspace(0.0, 120.0, 22)
    Lxy_bin = np.linspace(0.0, 100.0, 50)
    Lxy_sep = np.array([0.0, 1.0, 20.0, 100.0])
    dxy_sep = np.array([0.0, 1.0, 10.0, 100.0])



    #############################
    ####   Book Histograms   ####
    #############################
    hist_Lxy1 = r.TH1F('hist_Lxy1', '; Production radius r (cm); Events', len(Lxy_bin)-1, Lxy_bin)
    hist_Lxy2 = r.TH1F('hist_Lxy2', '; Production radius r (cm); Events', len(Lxy_bin)-1, Lxy_bin)
    hist_dxy1 = r.TH1F('hist_dxy1', '; Transverse impact parameter |d_{xy}| (cm); Events', len(dxy_bin)-1, dxy_bin)
    hist_dxy2 = r.TH1F('hist_dxy2', '; Transverse impact parameter |d_{xy}| (cm); Events', len(dxy_bin)-1, dxy_bin)
    hist_pt1 = r.TH1F('hist_pt1', '; Transverse momentum p_{T} (GeV); Events', len(pt_bin)-1, pt_bin)
    hist_pt2 = r.TH1F('hist_pt2', '; Transverse momentum p_{T} (GeV); Events', len(pt_bin)-1, pt_bin)
    hist_mass = r.TH1F('hist_mass', '; Mass(l1, l2) (GeV); Events', 40, 0, 500)
    hist_dR = r.TH1F('hist_dR', '; #DeltaR(l1, l2) (GeV); Events', 20, 0, 4)

    #hist2D_dRnEle = r.TH2F('hist_dRnEle', '; #DeltaR(l1, l2); Number of status 1 electrons;', 20, 0, 4, 7, 0, 7)
    #hist2D_pt2dR = r.TH2F('hist_pt2dR', '; Subleading lepton p_{T} (GeV);#DeltaR(l1, l2);', 30, 0, 200, 20, 0, 3)

    ######################################
    ####   Book TEfficiency objects   ####
    ######################################
    eff_pt1 = r.TEfficiency("eff_pt1", ";p_{T} (GeV);Efficiency", len(pt_bin)-1, pt_bin)
    eff_pt2 = r.TEfficiency("eff_pt2", ";p_{T} (GeV);Efficiency", len(pt_bin)-1, pt_bin)
    eff_pt_12 = r.TEfficiency("eff_pt_12", ";Leading electron p_{T} (GeV);Subleading electron p_{T} GeV", len(pt_bin)-1, pt_bin, len(pt_bin) -1, pt_bin)

    eff_pt2_bin1 = r.TEfficiency("eff_pt2_bin1", ";Subleading electron p_{T} (GeV);Efficiency", len(pt_bin)-1, pt_bin)
    eff_pt2_bin2 = r.TEfficiency("eff_pt2_bin2", ";Subleading electron p_{T} (GeV);Efficiency", len(pt_bin)-1, pt_bin)
    eff_pt2_bin3 = r.TEfficiency("eff_pt2_bin3", ";Subleading electron p_{T} (GeV);Efficiency", len(pt_bin)-1, pt_bin)
    eff_pt2_bin1_dxy = r.TEfficiency("eff_pt2_bin1_dxy", ";Subleading electron p_{T} (GeV);Efficiency", len(pt_bin)-1, pt_bin)
    eff_pt2_bin2_dxy = r.TEfficiency("eff_pt2_bin2_dxy", ";Subleading electron p_{T} (GeV);Efficiency", len(pt_bin)-1, pt_bin)
    eff_pt2_bin3_dxy = r.TEfficiency("eff_pt2_bin3_dxy", ";Subleading electron p_{T} (GeV);Efficiency", len(pt_bin)-1, pt_bin)

    eff_Lxy1 = r.TEfficiency("eff_Lxy1", ";Production radius r (cm);Efficiency", len(Lxy_bin)-1, Lxy_bin)
    eff_Lxy2 = r.TEfficiency("eff_Lxy1", ";Production radius r (cm);Efficiency", len(Lxy_bin)-1, Lxy_bin)
    eff_Lxy_12 = r.TEfficiency("eff_Lxy_12", ";Leading lepton r (cm) ;Subleading lepton r (cm)", len(Lxy_bin)-1, Lxy_bin, len(Lxy_bin) -1, Lxy_bin)

    eff_Lxy1_log = r.TEfficiency("eff_Lxy1_log", ";Production radius r (cm);Efficiency", len(Lxy_logbin)-1, Lxy_logbin)
    eff_Lxy2_log = r.TEfficiency("eff_Lxy2_log", ";Production radius r (cm);Efficiency", len(Lxy_logbin)-1, Lxy_logbin)

    eff_dxy1 = r.TEfficiency("eff_dxy1", ";Transverse impact parameter |d_{xy}| (cm);Efficiency", len(dxy_bin_log)-1, dxy_bin_log)
    eff_dxy2 = r.TEfficiency("eff_dxy2", ";;", len(dxy_bin_log)-1, dxy_bin_log)

    #eff_pt1Lxy1 = r.TEfficiency("eff_pt1Lxy1", ";Leading lepton p_{T} (GeV);Leading lepton r (cm)", len(pt_bin)-1, pt_bin, len(Lxy_bin) -1, Lxy_bin)
    #eff_pt2Lxy2 = r.TEfficiency("eff_pt2Lxy2", ";Subleading lepton p_{T} (GeV);Subleading r (cm)", len(pt_bin)-1, pt_bin, len(Lxy_bin) -1, Lxy_bin)

    #eff_dR = r.TEfficiency("eff_dR", ";#DeltaR(l1, l2);Efficiency", 20, 0.0, 4.0)
    #eff_mass = r.TEfficiency("eff_mass", ";Mass(l1, l2) (GeV);Efficiency", 40, 0.0, 500.0)
    #eff_nConv = r.TEfficiency("eff_nConv", ";Number of electrons (PromptHadron);Efficiency", 10, 0.0, 12)

    #eff_eta_12 = r.TEfficiency("eff_eta_12", ";Leading lepton #eta;Subleading lepton #eta", 16, 0, 2.4, 16, 0, 2.4)

    #eff_pt2dR = r.TEfficiency("eff_pt2dR", ";Subleading lepton p_{T} (GeV);#DeltaR(l_{1}, l_{2})", 30, 0, 300, 16, 0, 4)

    #########################
    ####   Load sample   ####
    #########################
    _sampleNames = (opts.filename).split(',')
    _tree = r.TChain('Events')
    for _name in _sampleNames:
        _tree.Add(_name)
    print("TTree with " + str(_tree.GetEntries()) + " entries")

    ###################################
    ####   Loop over tree events   ####
    ###################################

    for i in range(0, _tree.GetEntries()):

        _tree.GetEntry(i)
        if opts.maxNumber:
            if i > opts.maxNumber: break

        # Get electrons:
        nPromptEle = 0
        var_values = []
        for l in range(_tree.nGenLepton):
            if not abs(_tree.GenLeptonSel_pdgId[l]) == 11: continue
            if _tree.GenLeptonSel_isPromptFinalState[l]: nPromptEle+=1
            var_values.append((_tree.GenLeptonSel_pt[l], l))

        # If there are no electrons we do NOT fill the TEfficiencies:
        #if len(var_values) != 2: continue
        if nPromptEle != 2: continue

        # Sort by pt:
        var_values.sort(reverse = True, key = lambda x: x[0])

        # Get leading and subleaging electrons:
        i1 = var_values[0][1]
        i2 = var_values[1][1]
        pt1 = _tree.GenLeptonSel_pt[i1]
        pt2 = _tree.GenLeptonSel_pt[i2]
        dxy1 = abs(_tree.GenLeptonSel_dxy[i1])
        dxy2 = abs(_tree.GenLeptonSel_dxy[i2])
        Lxy1 = math.sqrt((_tree.GenLeptonSel_vx[i1])**2 + (_tree.GenLeptonSel_vy[i1])**2)
        Lxy2 = math.sqrt((_tree.GenLeptonSel_vx[i2])**2 + (_tree.GenLeptonSel_vy[i2])**2)
        eta1 = _tree.GenLeptonSel_eta[i1]
        eta2 = _tree.GenLeptonSel_eta[i2]
        Lxy = Lxy1
        

        ### Other variables:
        l1 = r.TLorentzVector()
        l2 = r.TLorentzVector()
        l1.SetPtEtaPhiM(_tree.GenLeptonSel_pt[i1], _tree.GenLeptonSel_eta[i1], _tree.GenLeptonSel_phi[i1], 0.510/1000.0)
        l2.SetPtEtaPhiM(_tree.GenLeptonSel_pt[i2], _tree.GenLeptonSel_eta[i2], _tree.GenLeptonSel_phi[i2], 0.510/1000.0)

        dR = l1.DeltaR(l2)
        mass = (l1+l2).M()


        ############################
        ####   Cut definition   ####
        ############################
        pt1_cut = pt1 > 80
        pt2_cut = pt2 > 50
        Lxy1_cut = Lxy1 < 80
        Lxy2_cut = Lxy2 < 80
        resonance = mass < 100
        prompt = Lxy1 < 1 and Lxy2 < 1
        eta1_cut = abs(eta1) < 2
        eta2_cut = abs(eta2) < 2
        dR_cut = dR > 0.2

        #####################
        ####   Filling   ####
        #####################
        #if pt1_cut and pt2_cut and Lxy1_cut and Lxy2_cut: # pt + Lxy cuts
        #if pt1_cut and pt2_cut: # pt cuts only
        #if pt2_cut: # pt2 cut
        #if pt1_cut: # pt1 cut
        #if resonance: # check inside X resonance
        #if not resonance: # check outside X resonance
        #if prompt and pt1_cut: # no cuts
        #if eta1_cut and eta2_cut and dR_cut and pt2_cut and pt1_cut:
        #if eta1_cut and eta2_cut and dR_cut and pt1_cut:
        #if eta1_cut and eta2_cut and dR_cut and pt2_cut:
        #if True:
 
        if dR < 0.2: continue
        if opts.Lxy and Lxy1 > opts.Lxy: continue
        if opts.eta1 and abs(eta1) > opts.eta1: continue
        if opts.eta2 and abs(eta2) > opts.eta2: continue
        if opts.pt1 and pt1 < opts.pt1: continue
        if opts.pt2 and pt2 < opts.pt2: continue


        if True:

            hist_Lxy1.Fill(Lxy1)
            hist_Lxy2.Fill(Lxy2)
            hist_dxy1.Fill(dxy1)
            hist_dxy2.Fill(dxy2)
            hist_pt1.Fill(pt1)
            hist_pt2.Fill(pt2)
            hist_mass.Fill(mass)
            hist_dR.Fill(dR)
            #hist2D_dRnEle.Fill(dR, nPromptEle)
            #hist2D_pt2dR.Fill(pt2, dR)


            eff_pt1.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, pt1)
            eff_pt2.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, pt2)
            eff_pt_12.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, pt1, pt2)

            eff_Lxy1.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, Lxy1)
            eff_Lxy2.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, Lxy2)
            eff_Lxy_12.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, Lxy1, Lxy2)
            eff_Lxy1_log.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, Lxy1)
            eff_Lxy2_log.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, Lxy2)
            eff_dxy1.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, dxy1)
            eff_dxy2.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, dxy2)


            if Lxy < Lxy_sep[1]:
                eff_pt2_bin1.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, pt2)
            elif Lxy > Lxy_sep[1] and Lxy < Lxy_sep[2]:
                eff_pt2_bin2.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, pt2)
            elif Lxy > Lxy_sep[1] and Lxy < Lxy_sep[3]:
                eff_pt2_bin3.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, pt2)

            if dxy2 < dxy_sep[1]:
                eff_pt2_bin1_dxy.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, pt2)
            elif dxy2 > dxy_sep[1] and dxy2 < dxy_sep[2]:
                eff_pt2_bin2_dxy.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, pt2)
            elif dxy2 > dxy_sep[1] and dxy2 < dxy_sep[3]:
                eff_pt2_bin3_dxy.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, pt2)


            #eff_pt1Lxy1.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, pt1, Lxy1)
            #eff_pt2Lxy2.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, pt2, Lxy2)


            #eff_dR.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, dR)
            #eff_mass.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, mass)
        
            #eff_eta_12.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, abs(eta1), abs(eta2))

            #eff_pt2dR.Fill(_tree.Flag_HLT_Photon42_R9Id85_OR_CaloId24b40e_Iso50T80L_Photon25_AND_HE10_R9Id65_Eta2_Mass15, pt2, dR)

    ###########################
    ####   Write in file   ####
    ###########################
    if not os.path.exists(outputPath): os.makedirs(outputPath)
    outputFile = TFile(outputPath + 'ElectronTrigger.root', 'RECREATE')

    eff_pt1.Write()
    eff_pt2.Write()
    eff_pt2_bin1.Write()
    eff_pt2_bin2.Write()
    eff_pt2_bin3.Write()
    eff_pt2_bin1_dxy.Write()
    eff_pt2_bin2_dxy.Write()
    eff_pt2_bin3_dxy.Write()
    eff_Lxy1.Write()
    eff_Lxy1_log.Write()
    hist_pt1.Write()
    hist_pt2.Write()
    hist_Lxy1.Write()
    hist_Lxy2.Write()
    hist_dxy1.Write()
    hist_dxy2.Write()
    hist_mass.Write()
    hist_dR.Write()

    outputFile.Close()

    """
    ###########################
    ####   OF histograms   ####
    ###########################
    OFhist_pt1 = makeOFHisto(hist_pt1)
    OFhist_pt2 = makeOFHisto(hist_pt2)
    OFhist_Lxy1 = makeOFHisto(hist_Lxy1)
    OFhist_Lxy2 = makeOFHisto(hist_Lxy2)
    OFhist_dxy1 = makeOFHisto(hist_dxy1)
    OFhist_dxy2 = makeOFHisto(hist_dxy2)
    OFhist_mass = makeOFHisto(hist_mass)
    OFhist_dR = makeOFHisto(hist_dR)


    #######################
    ####   Plot tags   ####
    #######################
    #sampletag = 'Monte Carlo: DYJetsToLL_M-50'
    sampletag = 'Monte Carlo: H #rightarrow XX #rightarrow 2e2#mu'
    #cutstag = '|#eta_{1}|, |#eta_{2}| < 2, #DeltaR > 0.2,  p_{T2} > 50 GeV'
    #cutstag = '|#eta_{1}|, |#eta_{2}| < 2, #alpha_{12} < 2.5, #DeltaR > 0.2, p_{T2} > 50 GeV'
    #cutstag = '|#eta_{1}|, |#eta_{2}| < 2, #alpha_{12} < 2.5, #DeltaR > 0.2, p_{T1} > 80 GeV'
    cutstag = '|#eta_{1}|, |#eta_{2}| < 2, #alpha_{12} < 2.5, #DeltaR > 0.2, p_{T1} > 80 GeV, p_{T2} > 50 GeV'


    ######################
    ####   Plotting   ####
    ######################
    valmax = OFhist_Lxy1.GetMaximum() if OFhist_Lxy1.GetMaximum() > OFhist_Lxy2.GetMaximum() else OFhist_Lxy2.GetMaximum()
    OFhist_Lxy1.SetMaximum(10.0*valmax)
    HIST_Lxy = Canvas.Canvas('hist_Lxy', 'png', 0.35, 0.84, 0.9, 0.89, 2)
    HIST_Lxy.addHisto(OFhist_Lxy1, 'HIST', '', 'l', r.kBlack, 1, 0)
    HIST_Lxy.addLatex(0.17, 0.85, cutstag, size = 0.03, align = 11)
    HIST_Lxy.addLatex(0.9, 0.93, sampletag, size = 0.03, align = 31)
    HIST_Lxy.save(1, 0, 1, '', '', outputDir = outputPath)

    valmax = OFhist_dxy1.GetMaximum() if OFhist_dxy1.GetMaximum() > OFhist_dxy2.GetMaximum() else OFhist_dxy2.GetMaximum()
    OFhist_dxy1.SetMaximum(10.0*valmax)
    HIST_dxy = Canvas.Canvas('hist_dxy', 'png', 0.57, 0.7, 0.72, 0.8, 1)
    HIST_dxy.addHisto(OFhist_dxy1, 'HIST', 'Leading electron', 'l', r.kBlue+2, 1, 0)
    HIST_dxy.addHisto(OFhist_dxy2, 'HIST, same', 'Subleading electron', 'l', r.kRed-7, 1, 1)
    HIST_dxy.addLatex(0.87, 0.85, cutstag, size = 0.03, align = 31)
    HIST_dxy.addLatex(0.9, 0.93, sampletag, size = 0.03, align = 31)
    HIST_dxy.save(1, 0, 1, '', '', outputDir = outputPath)

    valmax = OFhist_pt1.GetMaximum() if OFhist_pt1.GetMaximum() > OFhist_pt2.GetMaximum() else OFhist_pt2.GetMaximum()
    OFhist_pt1.SetMaximum(1.3*valmax)
    HIST_pt = Canvas.Canvas('hist_pt', 'png', 0.35, 0.84, 0.9, 0.89, 2)
    HIST_pt.addHisto(OFhist_pt1, 'HIST', 'Leading lepton', 'l', r.kBlue+2, 1, 0)
    HIST_pt.addHisto(OFhist_pt2, 'HIST, SAME', 'Subleading lepton', 'l', r.kBlue-7, 1, 1)
    HIST_pt.save(1, 0, 0, '', '', outputDir = outputPath)

    HIST_dR = Canvas.Canvas('hist_dR', 'png', 0.6, 0.84, 0.9, 0.89, 2)
    HIST_dR.addHisto(OFhist_dR, 'HIST', '', 'l', r.kBlue+2, 1, 0)
    HIST_dR.save(0, 0, 0, '', '', outputDir = outputPath)

    HIST_mass = Canvas.Canvas('hist_mass', 'png', 0.6, 0.84, 0.9, 0.89, 2)
    HIST_mass.addHisto(OFhist_mass, 'HIST', '', 'l', r.kBlue+2, 1, 0)
    HIST_mass.save(0, 0, 0, '', '', outputDir = outputPath)

    """
    """
    HIST_dRnEle = Canvas.Canvas('hist_dRnEle', 'png', 0.6, 0.84, 0.9, 0.89, 2)
    HIST_dRnEle.addHisto(hist2D_dRnEle, 'colz', '', 'l', r.kBlue+2, 1, 0)
    HIST_dRnEle.save(0, 0, 0, '', '', outputDir = outputPath)

    HIST_pt2dR = Canvas.Canvas('hist_pt2dR', 'png', 0.6, 0.84, 0.9, 0.89, 2)
    HIST_pt2dR.addHisto(hist2D_pt2dR, 'colz', '', 'l', r.kBlue+2, 1, 0)
    HIST_pt2dR.save(0, 0, 0, '', '', outputDir = outputPath)
    

    EFF_pt12 = Canvas.Canvas('EFF_pt12', 'png', 0.5, 0.84, 0.9, 0.89, 4)
    EFF_pt12.add2DRate(eff_pt_12, 'colz')
    EFF_pt12.save(0, 0, 0, '', '', outputDir = outputPath)

    EFF_Lxy12 = Canvas.Canvas('EFF_Lxy12', 'png', 0.5, 0.84, 0.9, 0.89, 4)
    EFF_Lxy12.add2DRate(eff_Lxy_12, 'colz')
    #EFF_Lxy12.addLatex(0.5, 0.935, 'l_{1} > 70 GeV, l_{2} > 50 GeV', size = 0.031)
    EFF_Lxy12.save(0, 0, 0, '', '', outputDir = outputPath)

    
    EFF_pt1Lxy1 = Canvas.Canvas('EFF_pt1Lxy1', 'png', 0.5, 0.84, 0.9, 0.89, 4)
    EFF_pt1Lxy1.add2DRate(eff_pt1Lxy1, 'colz')
    EFF_pt1Lxy1.save(0, 0, 0, '', '', outputDir = outputPath)

    EFF_pt2Lxy2 = Canvas.Canvas('EFF_pt2Lxy2', 'png', 0.5, 0.84, 0.9, 0.89, 4)
    EFF_pt2Lxy2.add2DRate(eff_pt2Lxy2, 'colz')
    EFF_pt2Lxy2.save(0, 0, 0, '', '', outputDir = outputPath)

    
    EFF_pt2dR = Canvas.Canvas('EFF_pt2dR', 'png', 0.5, 0.84, 0.9, 0.89, 4)
    EFF_pt2dR.add2DRate(eff_pt2dR, 'colz')
    EFF_pt2dR.save(0, 0, 0, '', '', outputDir = outputPath)

    EFF_eta12 = Canvas.Canvas('EFF_eta12', 'png', 0.5, 0.84, 0.9, 0.89, 4)
    EFF_eta12.add2DRate(eff_eta_12, 'colz')
    EFF_eta12.save(0, 0, 0, '', '', outputDir = outputPath)
    

    EFF_pt1 = Canvas.Canvas('EFF_pt1', 'png', 0.3, 0.84, 0.9, 0.89, 2)
    EFF_pt1.addRate(eff_pt1, 'AP', '', 'p', r.kBlack, True, 0, marker = 24)
    EFF_pt1.addLatex(0.17, 0.85, cutstag, size = 0.03, align = 11)
    EFF_pt1.addLatex(0.9, 0.93, sampletag, size = 0.03, align = 31)
    EFF_pt1.save(0, 0, 0, '', '', outputDir = outputPath)

    EFF_pt2 = Canvas.Canvas('EFF_pt2', 'png', 0.3, 0.84, 0.9, 0.89, 2)
    EFF_pt2.addRate(eff_pt2, 'AP', '', 'p', r.kBlack, True, 0, marker = 24)
    EFF_pt2.addLatex(0.17, 0.85, cutstag, size = 0.03, align = 11)
    EFF_pt2.addLatex(0.9, 0.93, sampletag, size = 0.03, align = 31)
    EFF_pt2.save(0, 0, 0, '', '', outputDir = outputPath)

    EFF_pt2 = Canvas.Canvas('EFF_pt2_Lxybin', 'png', 0.55, 0.15, 0.83, 0.27, 1)
    EFF_pt2.addRate(eff_pt2_bin1, 'AP', 'L_{xy} < 1 (cm)', 'p', r.kBlack, True, 0, marker = 24)
    EFF_pt2.addRate(eff_pt2_bin2, 'AP, same', '1 < L_{xy} < 20 (cm)', 'p', r.kBlue, True, 1, marker = 24)
    EFF_pt2.addRate(eff_pt2_bin3, 'AP, same', '20 < L_{xy} < 100 (cm)', 'p', r.kRed, True, 2, marker = 24)
    EFF_pt2.addLatex(0.17, 0.85, cutstag, size = 0.03, align = 11)
    EFF_pt2.addLatex(0.9, 0.93, sampletag, size = 0.03, align = 31)
    EFF_pt2.save(1, 0, 0, '', '', outputDir = outputPath)

    EFF_pt2 = Canvas.Canvas('EFF_pt2_dxybin', 'png', 0.55, 0.15, 0.83, 0.27, 1)
    EFF_pt2.addRate(eff_pt2_bin1_dxy, 'AP', '|d_{xy2}| < 1 (cm)', 'p', r.kBlack, True, 0, marker = 24)
    EFF_pt2.addRate(eff_pt2_bin2_dxy, 'AP, same', '1 < |d_{xy2}| < 10 (cm)', 'p', r.kBlue, True, 1, marker = 24)
    EFF_pt2.addRate(eff_pt2_bin3_dxy, 'AP, same', '10 < |d_{xy2}| < 100 (cm)', 'p', r.kRed, True, 2, marker = 24)
    EFF_pt2.addLatex(0.17, 0.85, cutstag, size = 0.03, align = 11)
    EFF_pt2.addLatex(0.9, 0.93, sampletag, size = 0.03, align = 31)
    EFF_pt2.save(1, 0, 0, '', '', outputDir = outputPath)


    
    EFF_Lxy = Canvas.Canvas('EFF_Lxy', 'png', 0.3, 0.84, 0.9, 0.89, 2)
    EFF_Lxy.addRate(eff_Lxy1, 'AP', 'Leading lepton', 'p', r.kBlue+2, True, 0, marker = 20)
    EFF_Lxy.addRate(eff_Lxy2, 'AP, SAME', 'Subleading lepton', 'p', r.kBlue-7, True, 0, marker = 20)
    EFF_Lxy.save(1, 0, 0, '', '', outputDir = outputPath, xlog = False)

    EFF_Lxy1 = Canvas.Canvas('EFF_Lxy1', 'png', 0.3, 0.84, 0.9, 0.89, 2)
    EFF_Lxy1.addRate(eff_Lxy1, 'AP', 'Leading lepton', 'p', r.kBlue+2, True, 0, marker = 20)
    EFF_Lxy1.save(0, 0, 0, '', '', outputDir = outputPath, xlog = False)

    EFF_Lxy2 = Canvas.Canvas('EFF_Lxy2', 'png', 0.3, 0.84, 0.9, 0.89, 2)
    EFF_Lxy2.addRate(eff_Lxy2, 'AP', 'Leading lepton', 'p', r.kBlue+2, True, 0, marker = 20)
    EFF_Lxy2.save(0, 0, 0, '', '', outputDir = outputPath, xlog = False)
    

    EFF_Lxy1_log = Canvas.Canvas('EFF_Lxy1_log', 'png', 0.3, 0.84, 0.9, 0.89, 2)
    EFF_Lxy1_log.addRate(eff_Lxy1_log, 'AP', 'Leading lepton', 'p', r.kBlack, True, 0, marker = 24)
    EFF_Lxy1_log.addLatex(0.17, 0.85, cutstag, size = 0.03, align = 11)
    EFF_Lxy1_log.addLatex(0.9, 0.93, sampletag, size = 0.03, align = 31)
    EFF_Lxy1_log.save(0, 0, 0, '', '', outputDir = outputPath, xlog = True)

    EFF_dxy = Canvas.Canvas('EFF_dxy', 'png', 0.15, 0.16, 0.44, 0.26, 1)
    EFF_dxy.addRate(eff_dxy1, 'AP', 'Leading electron', 'p', r.kBlue+2, True, 0, marker = 24)
    EFF_dxy.addRate(eff_dxy2, 'AP, SAME', 'Subleading electron', 'p', r.kRed-7, True, 1, marker = 24)
    EFF_dxy.addLatex(0.17, 0.85, cutstag, size = 0.03, align = 11)
    EFF_dxy.addLatex(0.9, 0.93, sampletag, size = 0.03, align = 31)
    EFF_dxy.save(1, 0, 0, '', '', outputDir = outputPath, xlog = True)

    
    EFF_Lxy2_log = Canvas.Canvas('EFF_Lxy2_log', 'png', 0.3, 0.84, 0.9, 0.89, 2)
    EFF_Lxy2_log.addRate(eff_Lxy2_log, 'AP', 'Leading lepton', 'p', r.kBlue+2, True, 0, marker = 20)
    EFF_Lxy2_log.save(0, 0, 0, '', '', outputDir = outputPath, xlog = True)
    

    
    EFF_dR = Canvas.Canvas('EFF_dR', 'png', 0.3, 0.84, 0.9, 0.89, 2)
    EFF_dR.addRate(eff_dR, 'AP', '', 'p', r.kBlue+2, True, 0, marker = 20)
    EFF_dR.save(0, 0, 0, '', '', outputDir = outputPath)

    EFF_mass = Canvas.Canvas('EFF_mass', 'png', 0.3, 0.84, 0.9, 0.89, 2)
    EFF_mass.addRate(eff_mass, 'AP', '', 'p', r.kBlue+2, True, 0, marker = 20)
    EFF_mass.save(0, 0, 0, '', '', outputDir = outputPath)
    """
    
