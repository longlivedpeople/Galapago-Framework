##################################################################################################
#                                                                                                #    
#                                      ```...`                                                   #    
#                                   `......-::::.`...---.`                                       #    
#                                  ``     `.-::-.....---:::-`                                    #    
#                                           ..`      `.--:://-                                   #    
#                                     `//:`            .-:::/+:                                  #    
#                                    +m/`sy            `.-:://+`                                 #    
#                              `    :mMmdN/        .::.`.-:://+-                                 #    
#                   ``-//-----------odMMMs`      -yh:/m+.-:///+-                                 #    
#               `..--------/oyy/---::/+sh.      -mNd/omh-:://++.                                 #    
#             `.-------------:------::///:.     yNMMMMNs-:///+:                                  #    
#           `------------------------:::://:`   omNNNmy-:///+:`                                  #    
#          .--------........---------:::::/+/.  `+sys/-::/+++:`                                  #    
#         .---------.---------------:::::///++:..------::://+o+.                                 #    
#        .---------...-------------:::::://++/----------:::///+o-                                #    
#        -------------------------::::::////:---.-------::::///+o.                               #    
#       `:----------------------:::::::///:---..-------:::::///+o/                               #    
#       .:--------------------:::::://///:-------------::::////+o+             `.-               #    
#       `::---------------:::::::://////:------------::::::///+++/            ..-:               #    
#       `::::--------:::::::////////////-----------::::://///++++-           .--:/`  ``..        #    
#        -/:::::::::::://///////////////--------::::://////+++++/`          .--:/+...--/.        #    
#         :///::::://////++++++++++++++/-----::::///////++++++//.         `.---::----:/:         #    
#          :+//////++++++++++++++++++o+/-:::::///////++++++++/:`         `..-------:/+/`````.`   #    
#           ./++++ooooooooooooooooooo/:::::///+++++++++++++//-`         `.---------///-..--:-    #    
#            `-+osssso/+sssssssssso+/::://+++ooooooooo+++/:-`          `----------------://-     #    
#               .:+:.` `-+ossyyyysooo++++oosssssoooo++//+:.            ---------------:/+/.      #    
#                         `-/+osyyyyyysssyysssssoo++++++oso/.----.````.-------------://+/`       #    
#                             `..-://+++osysssssooosyso+ooossydhs+----------------:://++:        #    
#                                       `+ssssssssssyyyo+++++/:--------------::::////////-`      #    
#                   `                  -+osooooooooosshhs/:----..--------::://////++//:----.     #    
#           ..`    ...`               :ssooooossssssyyy+:------------::/++ooooooooooo+/:----.`   #    
#           .--..``-.--`              .oysssssssssshdo:----------::/++ossyhddhhdo....--------`   #    
#     ``    `:-.---:----`             .----------:+mh:------:://++oohhhdddddddddms`              #    
#    `.......-:----------.`          .-...```````..smy++//++ooooooooyddddddddddddmy`             #    
#      `.-------------------.`````..-/:--.....`````.:shhhdddho/::/+oohdddddhhhhhddms             #    
#         `-------....--------------/:-...````````````..----:/.` ``-/+hddddhhhddddmd:            #    
#           `.-----.--..-----------:/:-....````````````````..::``  `.:ommddhdddmmmmms            #    
#             `---------------::://++:--......``````````....--/:`````.:sdddmmmmmdddmh`           #    
#             .--------:://+++++//:-//:--.....................-/-````.-/yydhyyyhhhhdd`           #    
#           `..----:://///:--..``   :+::--------..............-//.```.-:sdhyyyyyhhhhd`           #    
#          ..--::://::-..-://+///:-`.o/::----.................-:+:.``..:+hyyyyyyhhhhs            #    
#         .-::-..`   `:+ooooooooooso/o+:::---------------------:++-....:/yyyyyyyyhhh:            #    
#          `        .syso+++++++oooosso+/::::::-----------::::::+s/-..--:shyyyyyhhys`            #    
#                `.../yysoooooo+oooossyso///::------------::://++yo:---:/ohyyyyhhys.             #    
#                :o+:`.oysoooooooooossyhhoo+:----------:::::://++dh+::::/+dhhhhhys.              #    
#                .ooo:``ohyssoooooosssyhhoooo+:------::::::////++ymo//::/+dhhddh/`               #    
#                 /sso:``ohyyssssssssyyhdysooooo/:::://++///++++shds+////+mddho-                 #    
#                  :sss/.`odhyyyyyyyyyyhdddyssooso///+oysooooosshNhso++//+hyo-                   #    
#                   -syy+-.sdhhhyyyyyyyyyyhhhyyssssoosyyysssyhdmNdysso++/ossso+/-.               #    
#                    `/syo:-sddhhhyyyyysssyyhhhhyyyysosssssossyyhyyssso+ossoo++//-               #    
#                      `+hy/-oddhhyyyyssssyyyhddddhh+  `/oosssssssssoo+ydhho/:-.`                #    
#                       :osso:+ddhhyyyssssyyyhddhhyo.   `/oosssssssssssyhhhhhhhhy+.              #    
#                        -sso+::yddhyyyyyyyyyhho `       `:+osssssssssyhsoshdhhhhddo-`           #    
#                         .oys/--odddhhhhyyhhhs.           .:osyyyyyyhsoooyhdhyssyhds/           #    
#                          `/yy+:-/dmdddhhhhyo.             `yhhhhhysoosyhddhsoosyyds-           #    
#                            .+ys+/+dmdddhy+.               `shyssoosyhdddhysooosyhdo-`          #    
#                              .+so:-/::-.                   `-+oshhhhhhyyssoooosyhd/-           #    
#                                ``                        .:+oooo++oooooooooooosyhh-.           #    
#                                                        `+oooo++++++++++++++ooosyho`            #    
#                                                        +ssooooo++++++++++++oosyhd/.            #    
#                                                       `yyysssoooooooo+++oooosyyhh-.            #    
#                                                        sdhhyyyssssssssssssyyyhhd+-.            #    
#                                                        .hmddddhhhhhhhhhhhhhddddo:-             #    
#                                                         `:ohddmmddddddddddhyso/::              #    
#                                                            -:/++ooooooo++//:--.`               #    
##################################################################################################
#                           ____       _                                                         #
#                          / ___| __ _| | __ _ _ __   __ _  __ _  ___                            #
#                         | |  _ / _` | |/ _` | '_ \ / _` |/ _` |/ _ \                           #
#                         | |_| | (_| | | (_| | |_) | (_| | (_| | (_) |                          # 
#                     _____\____|\__,_|_|\__,_| .__/ \__,_|\__, |\___/ _                         #  
#                    |  ___| __ __ _ _ __ ___ |_|____      |___/  _ __| | _                      #_
#                    | |_ | '__/ _` | '_ ` _ \ / _ \ \ /\ / / _ \| '__| |/ /                     #
#                    |  _|| | | (_| | | | | | |  __/\ V  V / (_) | |  |   <                      # 
#                    |_|  |_|  \__,_|_| |_| |_|\___| \_/\_/ \___/|_|  |_|\_\                     #
#                                                                                                # 
##################################################################################################

import ROOT as r
from   ROOT import gROOT, TCanvas, TFile, TGraphErrors, SetOwnership
import math, sys, optparse, array, copy, os
import gc, inspect
import numpy as np

import include.Sample as Sample
import include.helper as helper
import include.Canvas as Canvas


####################################### CLASS DEFINITION #########################################

class bcolors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'



################################# GLOBAL VARIABLES DEFINITION ####################################

WORKPATH = os.path.abspath('./') + '/'

##################################### FUNCTION DEFINITION ########################################


def combineStack(stackList, xlabel):

    fullSet = {}
    histNumber = stackList[0].GetNhists()
    names = []

    for hist in stackList[0].GetHists():
        names.append(hist.GetTitle())
        fullSet[hist.GetTitle()] = hist

    for n in range(1, len(stackList)):

        for hist in stackList[n].GetHists():
            fullSet[hist.GetTitle()].Add(hist)


    aux_stack = r.THStack()
    for name in names:
        aux_stack.Add(fullSet[name])

    aux_c1 = TCanvas()
    aux_stack.Draw()
    aux_stack.GetXaxis().SetTitle(xlabel)
    aux_stack.GetYaxis().SetTitle('Events')
    aux_c1.Delete()

    return aux_stack
        


    
def makePlot(lumi, regs, var, name, xlabel, logx, treeMC, treeSI = False, treeDATA = False, LLlabel = False, normed = False):

    MCstackList = []

    for reg in regs:
        MCstackList.append(treeMC.getLoopStack('histMC_'+name, reg+'_'+var, xlabel))

    hMCS = combineStack(MCstackList, xlabel)

    luminosity = lumi

    ### MC total histogram
    f = 0
    for _i, _h in enumerate(hMCS.GetHists()):
        if not f: hMC = copy.deepcopy(_h)
        else: hMC.Add(_h, 1.)
        f = 1
    hMC.SetMarkerStyle(20) # Auxiliar to save the ratio correctly 

    ### Signal histograms
    if treeSI:

        hSIS = treeSI.getLoopStack('histSI_'+name, regs[0]+'_'+var, xlabel)

        s_histos = []
        for _i, _h in enumerate(hSIS.GetHists()):
            s_histos.append(copy.deepcopy(_h))

        for i in range(1, len(regs)):
            aux_hSIS = treeSI.getLoopStack('histSI_'+name, regs[i]+'_'+var, xlabel)
            for _i, _h in enumerate(aux_hSIS.GetHists()):
                s_histos[_i].Add(copy.deepcopy(_h))


    ### Data histogram
    if treeDATA:

        hDATA = treeDATA.getLoopTH1F('histDATA_'+name, regs[0] + '_' + var, xlabel)
        for i in range(1, len(regs)):
            if regs[i] == 'SR': continue # BLINDED
            hDATA.Add(treeDATA.getLoopTH1F('histDATA_'+name, regs[i] + '_' + var, xlabel))

        hDATA.SetMarkerStyle(20)
        hDATA.SetMarkerSize(0.8)
        #hDATA.Scale(hMC.Integral()/hDATA.Integral())

    # Normalization
    if normed:
        hMC.Scale(1.0/hMC.Integral())
        for _h in s_histos: _h.Scale(1.0/_h.Integral())
        luminosity = 1.0

    ### Get maximum
    maxValMC = hMC.GetMaximum()
    maxValSI = 0 if not treeSI else max([s_histos[i].GetMaximum() for i in range(0, len(s_histos))])
    maxValDATA = 0 if not treeDATA else hDATA.GetMaximum()
    maxVal = max([maxValMC, maxValSI, maxValDATA])

    ### Set Maximum
    if not logx:
        hMCS.SetMaximum(1.3*maxVal)
        hMCS.SetMinimum(0.0)
        hMC.SetMaximum(1.3*maxVal)
        hMC.SetMinimum(0.0)
        if treeSI:
            for _h in s_histos: 
                _h.SetMaximum(1.3*maxVal)
                _h.SetMinimum(0.0)
        if treeDATA:
            hDATA.SetMaximum(1.3*maxVal)
            hDATA.SetMinimum(0.0)
    else:
        hMCS.SetMaximum(10.0*maxVal)
        hMCS.SetMinimum(0.1)
        hMC.SetMaximum(10.0*maxVal)
        hMC.SetMinimum(0.1)
        if treeSI:
            for _h in s_histos: 
                _h.SetMaximum(10.0*maxVal)
                _h.SetMinimum(0.1)
        if treeDATA:
            hDATA.SetMaximum(10.0*maxVal)
            hDATA.SetMinimum(0.1)


    ### Canvas object
    if treeDATA:
        plot = Canvas.Canvas('hist_'+name, 'png', 0.34, 0.68, 0.9, 0.9, 2)
    else:
        plot = Canvas.Canvas('hist_'+name, 'png', 0.6, 0.6, 0.9, 0.9, 1)

    if normed: plot.addHisto(hMC, 'HIST', '', 'l', r.kBlue, 1, 0) # Background
    else: plot.addStack(hMCS, 'HIST', 1, 0) # Background

    if treeSI:
        for _h in s_histos:
            _h.SetLineWidth(2) # provisional
            plot.addHisto(_h, 'HIST, SAME', '', 'l', _h.GetFillColor(), 1, 3) # Signal

    if treeDATA:
        plot.addHisto(hDATA, 'P, SAME', '', 'p', r.kBlack, 1, 4)


    ### Dilepton banner
    if LLlabel == 'EE':
        plot.addLatex(0.17, 0.86, 'e^{+}e^{-} channel')
    if LLlabel == 'MM':
        plot.addLatex(0.17, 0.86, '#mu^{+}#mu^{-} channel')

    ### Save it

    regName = ''
    for reg in regs: regName = regName + reg + '_'

    if treeDATA:
        plot.saveRatio(1, 0, logx, luminosity, hDATA, hMC, label="Data/MC", outputDir = WORKPATH + regName + 'blindPlots/')
    else:
        plot.save(1, 0, logx, luminosity, '', outputDir = WORKPATH + regName + 'blindPlots/')


def makeSensitivity(lumi, regs, treeSI, treeMC, var, name, xlabel, logx, LLlabel = False, normed = False):

    hMCS = treeMC.getLoopTH1F('histMC_'+name, regs[0] + '_'+var, xlabel)

    for i in range(1, len(regs)):
        hMCS.Add(treeMC.getLoopTH1F('histMC_'+name, regs[i]+'_'+var, xlabel))



    luminosity = lumi

    ### Signal histograms
    if treeSI:

        hSIS = treeSI.getLoopStack('histSI_'+name, regs[0]+'_'+var, xlabel)

        s_histos = []
        for _i, _h in enumerate(hSIS.GetHists()):
            s_histos.append(copy.deepcopy(_h))

        for i in range(1, len(regs)):
            aux_hSIS = treeSI.getLoopStack('histSI_'+name, regs[i]+'_'+var, xlabel)
            for _i, _h in enumerate(aux_hSIS.GetHists()):
                s_histos[_i].Add(copy.deepcopy(_h))


    ### Get significance values
    plot = Canvas.Canvas('sensitivity_'+name, 'png', 0.5, 0.9 - 0.04*len(s_histos), 0.9, 0.9, 1)

    significances = []

    for _i, _h in enumerate(s_histos):
        gh = r.TH1F('gr', '', hMCS.GetNbinsX(), hMCS.GetXaxis().GetXmin(), hMCS.GetXaxis().GetXmax())
        for n in range(1, hMCS.GetNbinsX() + 1):
            sig_value = 0.0
            back_value = 0.0
            value = 0.0
            for j in range(n, hMCS.GetNbinsX() + 1):
                sig_value = sig_value + _h.GetBinContent(j)
                back_value = back_value + hMCS.GetBinContent(j)
            if sig_value + back_value == 0:
                value = 0.0
            else:
                value = sig_value/math.sqrt(sig_value + back_value)

            gh.SetBinContent(n, value)

        gh.SetTitle(_h.GetTitle())
        gh.SetLineWidth(2)
        gh.GetYaxis().SetTitle('S/#sqrt{S + B}')
        gh.GetXaxis().SetTitle(xlabel)
        gh.SetLineColor(_h.GetFillColor())
        significances.append(copy.deepcopy(gh))

   
    ### Get the maximum significance
    s_max = 0
    for s in significances:
        if s.GetMaximum() > s_max: s_max = s.GetMaximum()  

    ### Plot significances
    for _i,s in enumerate(significances):
        if _i == 0:
            s.SetMaximum(1.4*s_max)
            s.SetMaximum(1000.0*s_max)
            plot.addHisto(s, 'l', s.GetTitle(), 'l', s.GetLineColor(), 1, 1)
        else:
            plot.addHisto(s, 'l, same', s.GetTitle(), 'l', s.GetLineColor(), 1, 1)
            
    ### Dilepton banner
    if LLlabel == 'EE':
        plot.addLatex(0.17, 0.86, 'e^{+}e^{-} channel')
    if LLlabel == 'MM':
        plot.addLatex(0.17, 0.86, '#mu^{+}#mu^{-} channel')

    ### Save it
    plot.save(1, 0, logx, luminosity, '', outputDir = WORKPATH + 'sensitivity/')


def makeROC(lumi, treeSI, treeMC, var, name, xlabel, ylog, LLlabel = False, normed = False):

    hMCS = treeMC.getLoopTH1F('histMC_'+name, var, xlabel)
    hSIS = treeSI.getLoopStack('histSI_'+name, var, xlabel)

    luminosity = lumi

    ### Signal histograms
    s_histos = []
    for _i, _h in enumerate(hSIS.GetHists()):
        s_histos.append(copy.deepcopy(_h))

    ### Get significance values
    plot = Canvas.Canvas('ROC_'+name, 'png', 0.5, 0.2, 0.9, 0.4, 1)
    graphs = []

    for _i, _h in enumerate(s_histos):
        effs = []
        rejs = []
        for n in range(1, hMCS.GetNbinsX() + 1):
            sig_value = 0.0
            back_value = 0.0
            for j in range(n, hMCS.GetNbinsX() + 1):
                sig_value = sig_value + _h.GetBinContent(j)
                back_value = back_value + hMCS.GetBinContent(j)
            if sig_value + back_value == 0:
                effs.append(0.0)
                rejs.append(0.0)
            else:
                effs.append(sig_value/_h.Integral())
                rejs.append(back_value/hMCS.Integral())

        gh = r.TGraph(len(effs), np.array(rejs), np.array(effs))
        gh.SetMaximum(1.0)
        gh.SetMinimum(0.0)
        gh.GetXaxis().SetLimits(0.0, 1.0)
        gh.SetTitle(_h.GetTitle())
        gh.SetLineWidth(2)
        gh.GetYaxis().SetTitle('Selected signal/All signal')
        gh.GetXaxis().SetTitle('Selected background/All background')
        gh.SetLineColor(_h.GetFillColor())
        graphs.append(copy.deepcopy(gh))

    for _i,g in enumerate(graphs):
        if _i == 0:
            plot.addHisto(g, 'la', g.GetTitle(), 'l', g.GetLineColor(), 1, _i)
        else:
            plot.addHisto(g, 'l, same', g.GetTitle(), 'l', g.GetLineColor(), 1, _i)

    plot.save(1, 0, ylog, luminosity, '', outputDir = WORKPATH + 'sensitivity/', xlog = True)




if __name__ == "__main__":

    print bcolors.HEADER
    print "                                 ```.....`                              "        
    print "                               `.````.-:::-.-------.                    "        
    print "                              ``      .--.`````.--://-                  "
    print "                                   `   `        `-::://`                "
    print "                                `os/y:           .-::/+/                "
    print "                                yNdod+        ````-:://+`               "
    print "                 ``-/-..------.-hNMMs`     `oy/sy.-:://+.               "
    print "              `..------:+ss/--::/+sh.     `dNh/sN/-://+/`               "
    print "           `.-------------------::///.    /NMMMNm::///+-                "
    print "         `.---------------------:::://:`  -dmNNh/:///+-                 "
    print "        `--------.---.----------:::::/+/.``-++/:-://+o+.                "
    print "       `--------..--------------:::://++/---------:://++:               "
    print "       .----------------------::::::/++:----------::://+o:              "
    print "       ---------------------::::::://:---..------:::://++o`             "
    print "      `:-------------------::::::///:----.------::::://++o.             "
    print "      `::--------------::::::://///:-----------:::::///+++.             "
    print "       ::::------:::::::://////////----------:::::////+++/`             "
    print "       ./:::::::::::///////////////-------:::://////++++/-              "
    print "        -///////////++++++++++++++/----:::///////++++++/-               "
    print "         ./+///+++++ooooooooo+ooo+::::::///++++++++++//.                "
    print "          `-+ooosssooooosssssso+/:::///+++++oooo+++//-`                 "
    print "            `-+so/-.:+sssyyysso++///+oooooooooo++//-`                   "
    print "               ``    `.:+osyyyyysssssssssssoo++++oo+:`..```             "
    print "                         `.-:/+++oooyyysssooosso+ooosoyhyo/-.           "
    print "                                  ``+sssssssssyyso++++/:------::        "
    print "                                  -+oooooooooosyhy+:----.-------::      "
    print '########################################################################' 
    print '                  Starting IFCA-LLP analysis...                         '
    print '########################################################################' + bcolors.ENDC

    parser = optparse.OptionParser(usage='usage: %prog [opts] FilenameWithSamples', version='%prog 1.0')
    parser.add_option('-i', '--input', action='store', type=str, dest='inputFile', default='launchWithGridui/merged.root', help='the input file. default \'merged.root\'')

    (opts, args) = parser.parse_args()

    ############# Set the TDR plot style
    gROOT.ProcessLine('.L ' + WORKPATH + 'include/tdrstyle.C')
    gROOT.SetBatch(1)
    r.setTDRStyle()
    

    ############# Background definition
    Backgrounds = []
    Backgrounds.append('WJetsToLNu') 
    Backgrounds.append('WW') 
    Backgrounds.append('WZ') 
    Backgrounds.append('ZZ') 
    Backgrounds.append('TTJets_DiLept') 
    Backgrounds.append('DYJetsToLL_M-50') 
    Backgrounds.append('DYJetsToLL_M-10to50') 
    Backgrounds.append('QCD_Pt-30to40') 
    Backgrounds.append('QCD_Pt-40toInf') 


    ############# Signal definition
    SignalRPV = []
    SignalRPV.append('DisplacedSUSY_1500_494_160')
    SignalRPV.append('DisplacedSUSY_1000_148_60')
    SignalRPV.append('DisplacedSUSY_350_148_173')
#    Signal.append('DisplacedSUSY_120_48_165')
    SignalHXX = []
    SignalHXX.append('HXX_1000_350_350')
    SignalHXX.append('HXX_1000_350_35')
    SignalHXX.append('HXX_1000_150_100')
    SignalHXX.append('HXX_1000_150_10')
    SignalHXX.append('HXX_400_150_400')
    SignalHXX.append('HXX_400_150_40')

    Signal = []
    #Signal.append('HXX_400_150_400')
    Signal.append('HXX_1000_350_350')
    Signal.append('DisplacedSUSY_350_148_173')

    Signal = SignalHXX

    ############## Data definition
    MuonData = []
    MuonData.append('DoubleMuon-Run2016B')
    MuonData.append('DoubleMuon-Run2016C')
    MuonData.append('DoubleMuon-Run2016D')
    MuonData.append('DoubleMuon-Run2016E')
    MuonData.append('DoubleMuon-Run2016F')
    MuonData.append('DoubleMuon-Run2016G')
    MuonData.append('DoubleMuon-Run2016H')
    ElectronData = []
    ElectronData.append('DoubleEG-Run2016B')
    ElectronData.append('DoubleEG-Run2016C')
    ElectronData.append('DoubleEG-Run2016D')
    ElectronData.append('DoubleEG-Run2016E')
    ElectronData.append('DoubleEG-Run2016F')
    ElectronData.append('DoubleEG-Run2016G')
    ElectronData.append('DoubleEG-Run2016H')


    ############# Parameter definition
    lumi = 36.773 # luminosity

    ############# Tree creation
    treeMC = Sample.Tree(helper.selectSamples(WORKPATH + 'dat/MC.dat', Backgrounds, 'MC'), 'MC', 0, WORKPATH + opts.inputFile)
    treeSI = Sample.Tree(helper.selectSamples(WORKPATH + 'dat/SI.dat', Signal, 'SI'), 'SI', 0, WORKPATH + opts.inputFile)
    treeRPV = Sample.Tree(helper.selectSamples(WORKPATH + 'dat/SI.dat', SignalRPV, 'SI'), 'SI', 0, WORKPATH + opts.inputFile)
    treeHXX = Sample.Tree(helper.selectSamples(WORKPATH + 'dat/SI.dat', SignalHXX, 'SI'), 'SI', 0, WORKPATH + opts.inputFile)
    treeMuonDATA = Sample.Tree(helper.selectSamples(WORKPATH + 'dat/DATA.dat', MuonData, 'DATA'), 'DATA', 1, WORKPATH + opts.inputFile)
    treeElectronDATA = Sample.Tree(helper.selectSamples(WORKPATH + 'dat/DATA.dat', ElectronData, 'DATA'), 'DATA', 1, WORKPATH + opts.inputFile)


#    makePlot(lumi, [''], 'counts', 'counts', 'Weighted counts', 0, treeMC, treeSI, False, 'MM')

    makePlot(lumi, ['SR'], 'MMsel_Chi2', 'SR_MMsel_Chi2', 'Vertex #Chi^{2}', 1, treeMC, treeSI, False, 'MM')
    
    #makeROC(lumi, treeSI, treeMC, 'SR_EEsel_minIxy', 'SR_EEsel_minIxy', '|d_{0}|/#sigma_{d}', ylog = True, LLlabel = 'EE')
    makeSensitivity(lumi, ['SR', 'CR2'], treeRPV, treeMC, 'EEsel_minIxy', 'RPV_EEsel_minIxy', '|d_{0}|/#sigma_{d}', 1, 'EE')
    makeSensitivity(lumi, ['SR', 'CR2'], treeRPV, treeMC, 'MMsel_minIxy', 'RPV_MMsel_minIxy', '|d_{0}|/#sigma_{d}', 1, 'MM')
    makeSensitivity(lumi, ['SR', 'CR2'], treeHXX, treeMC, 'EEsel_minIxy', 'HXX_EEsel_minIxy', '|d_{0}|/#sigma_{d}', 1, 'EE')
    makeSensitivity(lumi, ['SR', 'CR2'], treeHXX, treeMC, 'MMsel_minIxy', 'HXX_MMsel_minIxy', '|d_{0}|/#sigma_{d}', 1, 'MM')
    


    makePlot(lumi, ['SR'], 'MMsel_minIxy', 'SR_MMsel_minIxy', '|d_{0}|/#sigma_{d}', 1, treeMC, treeSI, False, 'MM') 
    makePlot(lumi, ['SR'], 'MMsel_invMass', 'SR_MMsel_invMass', 'Mass (GeV/c^{2})', 1, treeMC, treeSI, False, 'MM')
    makePlot(lumi, ['SR'], 'MMsel_Chi2', 'SR_MMsel_Chi2', 'Vertex #Chi^{2}', 1, treeMC, treeSI, False, 'MM')
    makePlot(lumi, ['SR'], 'MMsel_dPhi', 'SR_MMsel_dPhi', 'Collinearity |#Delta#Phi|', 1, treeMC, treeSI, False, 'MM')
    makePlot(lumi, ['SR'], 'MMsel_leadingPt', 'SR_MMsel_leadingPt', 'Leading p_{T} (GeV/c)', 1, treeMC, treeSI, False, 'MM')
    makePlot(lumi, ['SR'], 'MMsel_subleadingPt', 'SR_MMsel_subleadingPt', 'Subleading p_{T} (GeV/c)', 1, treeMC, treeSI, False, 'MM')
    makePlot(lumi, ['SR'], 'MMsel_cosAlpha', 'SR_MMsel_cosAlpha', 'cos(#alpha)', 1, treeMC, treeSI, False, 'MM')
    makePlot(lumi, ['SR'], 'MMsel_Ptll', 'SR_MMsel_Ptll', 'p_{T}(ll)', 1, treeMC, treeSI, False, 'MM')

    makePlot(lumi, ['CR2', 'SR'], 'MMsel_minIxy', 'SR_MMsel_minIxy', '|d_{0}|/#sigma_{d}', 1, treeMC, treeSI, treeMuonDATA, 'MM') 
    makePlot(lumi, ['CR2', 'SR'], 'MMsel_invMass', 'SR_MMsel_invMass', 'Mass (GeV/c^{2})', 1, treeMC, treeSI, treeMuonDATA, 'MM')
    makePlot(lumi, ['CR2', 'SR'], 'MMsel_Chi2', 'SR_MMsel_Chi2', 'Vertex #Chi^{2}', 1, treeMC, treeSI, treeMuonDATA, 'MM')
    makePlot(lumi, ['CR2', 'SR'], 'MMsel_dPhi', 'SR_MMsel_dPhi', 'Collinearity |#Delta#Phi|', 1, treeMC, treeSI, treeMuonDATA, 'MM')
    makePlot(lumi, ['CR2', 'SR'], 'MMsel_leadingPt', 'SR_MMsel_leadingPt', 'Leading p_{T} (GeV/c)', 1, treeMC, treeSI, treeMuonDATA, 'MM')
    makePlot(lumi, ['CR2', 'SR'], 'MMsel_subleadingPt', 'SR_MMsel_subleadingPt', 'Subleading p_{T} (GeV/c)', 1, treeMC, treeSI, treeMuonDATA, 'MM')
    makePlot(lumi, ['CR2', 'SR'], 'MMsel_cosAlpha', 'SR_MMsel_cosAlpha', 'cos(#alpha)', 1, treeMC, treeSI, treeMuonDATA, 'MM')
    makePlot(lumi, ['CR2', 'SR'], 'MMsel_Ptll', 'SR_MMsel_Ptll', 'p_{T}(ll)', 1, treeMC, treeSI, treeMuonDATA, 'MM')


    makePlot(lumi, ['CR1A', 'CR1B'], 'MMsel_minIxy', 'CR1_MMsel_minIxy', '|d_{0}|/#sigma_{d}', 1, treeMC, treeSI, treeMuonDATA, 'MM')
    makePlot(lumi, ['CR1A', 'CR1B'], 'MMsel_invMass', 'CR1_MMsel_invMass','Mass (GeV/c^{2})', 1, treeMC, treeSI, treeMuonDATA, 'MM')
    makePlot(lumi, ['CR1A', 'CR1B'], 'MMsel_Chi2', 'CR1_MMsel_Chi2', 'Vertex #Chi^{2}', 1, treeMC, treeSI, treeMuonDATA, 'MM')
    makePlot(lumi, ['CR1A', 'CR1B'], 'MMsel_dPhi', 'CR1_MMsel_dPhi', 'Collinearity |#Delta#Phi|', 1, treeMC, treeSI, treeMuonDATA, 'MM')
    makePlot(lumi, ['CR1A', 'CR1B'], 'MMsel_leadingPt', 'CR1_MMsel_leading1', 'Leading p_{T} (GeV/c)', 1, treeMC, treeSI, treeMuonDATA, 'MM')
    makePlot(lumi, ['CR1A', 'CR1B'], 'MMsel_subleadingPt', 'CR1_MMsel_subleadingPt', 'Subleading p_{T} (GeV/c)', 1, treeMC, treeSI, treeMuonDATA, 'MM')
    makePlot(lumi, ['CR1A', 'CR1B'], 'MMsel_cosAlpha', 'CR1_MMsel_cosAlpha', 'cos(#alpha)', 1, treeMC, treeSI, treeMuonDATA, 'MM')
    makePlot(lumi, ['CR1A', 'CR1B'], 'MMsel_Ptll', 'CR1_MMsel_Ptll', 'p_{T}(ll)', 1, treeMC, treeSI, treeMuonDATA, 'MM')


    makePlot(lumi, ['SR'], 'EEsel_minIxy', 'SR_EEsel_minIxy', '|d_{0}|/#sigma_{d}', 1, treeMC, treeSI, False, 'EE')
    makePlot(lumi, ['SR'], 'EEsel_invMass', 'SR_EEsel_invMass', 'Mass (GeV/c^{2})', 1, treeMC, treeSI, False, 'EE')
    makePlot(lumi, ['SR'], 'EEsel_Chi2', 'SR_EEsel_Chi2', 'Vertex #Chi^{2}', 1, treeMC, treeSI, False, 'EE')
    makePlot(lumi, ['SR'], 'EEsel_dPhi', 'SR_EEsel_dPhi', 'Collinearity |#Delta#Phi|', 1, treeMC, treeSI, False, 'EE')
    makePlot(lumi, ['SR'], 'EEsel_leadingPt', 'SR_EEsel_leadingPt', 'Leading p_{T} (GeV/c)', 1, treeMC, treeSI, False, 'EE')
    makePlot(lumi, ['SR'], 'EEsel_subleadingPt', 'SR_EEsel_subleadingPt', 'Subleading p_{T} (GeV/c)', 1, treeMC, treeSI, False, 'EE')
    makePlot(lumi, ['SR'], 'EEsel_Ptll', 'SR_EEsel_Ptll', 'p_{T}(ll)', 1, treeMC, treeSI, False, 'EE')

    makePlot(lumi, ['CR2', 'SR'], 'EEsel_minIxy', 'SR_EEsel_minIxy', '|d_{0}|/#sigma_{d}', 1, treeMC, treeSI, treeElectronDATA, 'EE')
    makePlot(lumi, ['CR2', 'SR'], 'EEsel_invMass', 'SR_EEsel_invMass', 'Mass (GeV/c^{2})', 1, treeMC, treeSI, treeElectronDATA, 'EE')
    makePlot(lumi, ['CR2', 'SR'], 'EEsel_Chi2', 'SR_EEsel_Chi2', 'Vertex #Chi^{2}', 1, treeMC, treeSI, treeElectronDATA, 'EE')
    makePlot(lumi, ['CR2', 'SR'], 'EEsel_dPhi', 'SR_EEsel_dPhi', 'Collinearity |#Delta#Phi|', 1, treeMC, treeSI, treeElectronDATA, 'EE')
    makePlot(lumi, ['CR2', 'SR'], 'EEsel_leadingPt', 'SR_EEsel_leadingPt', 'Leading p_{T} (GeV/c)', 1, treeMC, treeSI, treeElectronDATA, 'EE')
    makePlot(lumi, ['CR2', 'SR'], 'EEsel_subleadingPt', 'SR_EEsel_subleadingPt', 'Subleading p_{T} (GeV/c)', 1, treeMC, treeSI, treeElectronDATA, 'EE')
    makePlot(lumi, ['CR2', 'SR'], 'EEsel_Ptll', 'SR_EEsel_Ptll', 'p_{T}(ll)', 1, treeMC, treeSI, treeElectronDATA, 'EE')

    makePlot(lumi, ['CR1A', 'CR1B'], 'EEsel_minIxy', 'CR1_EEsel_minIxy', '|d_{0}|/#sigma_{d}', 1, treeMC, treeSI, treeElectronDATA, 'EE')
    makePlot(lumi, ['CR1A', 'CR1B'], 'EEsel_invMass', 'CR1_EEsel_invMass', 'Mass (GeV/c^{2})', 1, treeMC, treeSI, treeElectronDATA, 'EE')
    makePlot(lumi, ['CR1A', 'CR1B'], 'EEsel_Chi2', 'CR1_EEsel_Chi2', 'Vertex #Chi^{2}', 1, treeMC, treeSI, treeElectronDATA, 'EE')
    makePlot(lumi, ['CR1A', 'CR1B'], 'EEsel_dPhi', 'CR1_EEsel_dPhi', 'Collinearity |#Delta#Phi|', 1, treeMC, treeSI, treeElectronDATA, 'EE')
    makePlot(lumi, ['CR1A', 'CR1B'], 'EEsel_leadingPt', 'CR1_EEsel_leadingPt', 'Leading p_{T} (GeV/c)', 1, treeMC, treeSI, treeElectronDATA, 'EE')
    makePlot(lumi, ['CR1A', 'CR1B'], 'EEsel_subleadingPt', 'CR1_EEsel_subleadingPt', 'Subleading p_{T} (GeV/c)', 1, treeMC, treeSI, treeElectronDATA, 'EE')
    makePlot(lumi, ['CR1A', 'CR1B'], 'EEsel_Ptll', 'CR1_EEsel_Ptll', 'p_{T}(ll)', 1, treeMC, treeSI, treeElectronDATA, 'EE')
