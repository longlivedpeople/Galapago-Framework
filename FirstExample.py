##################################################################################################
#                                                                                                #    
#                                      ```...`                                                   #    
#                                   `......-::::.`...---.`                                       #    
#                                  ``     `.-::-.....---:::-`                                    #    
#                                           ..`      `.--:://-                                   #    
#                                     `//:`            .-:::/+:                                  #    
#                                    +m/`sy            `.-:://+`                                 #    
#                              `    :mMmdN/        .::.`.-:://+-                                 #    
#                   ``-//-----------odMMMs`      -yh:/m+.-:///+-                                 #    
#               `..--------/oyy/---::/+sh.      -mNd/omh-:://++.                                 #    
#             `.-------------:------::///:.     yNMMMMNs-:///+:                                  #    
#           `------------------------:::://:`   omNNNmy-:///+:`                                  #    
#          .--------........---------:::::/+/.  `+sys/-::/+++:`                                  #    
#         .---------.---------------:::::///++:..------::://+o+.                                 #    
#        .---------...-------------:::::://++/----------:::///+o-                                #    
#        -------------------------::::::////:---.-------::::///+o.                               #    
#       `:----------------------:::::::///:---..-------:::::///+o/                               #    
#       .:--------------------:::::://///:-------------::::////+o+             `.-               #    
#       `::---------------:::::::://////:------------::::::///+++/            ..-:               #    
#       `::::--------:::::::////////////-----------::::://///++++-           .--:/`  ``..        #    
#        -/:::::::::::://///////////////--------::::://////+++++/`          .--:/+...--/.        #    
#         :///::::://////++++++++++++++/-----::::///////++++++//.         `.---::----:/:         #    
#          :+//////++++++++++++++++++o+/-:::::///////++++++++/:`         `..-------:/+/`````.`   #    
#           ./++++ooooooooooooooooooo/:::::///+++++++++++++//-`         `.---------///-..--:-    #    
#            `-+osssso/+sssssssssso+/::://+++ooooooooo+++/:-`          `----------------://-     #    
#               .:+:.` `-+ossyyyysooo++++oosssssoooo++//+:.            ---------------:/+/.      #    
#                         `-/+osyyyyyysssyysssssoo++++++oso/.----.````.-------------://+/`       #    
#                             `..-://+++osysssssooosyso+ooossydhs+----------------:://++:        #    
#                                       `+ssssssssssyyyo+++++/:--------------::::////////-`      #    
#                   `                  -+osooooooooosshhs/:----..--------::://////++//:----.     #    
#           ..`    ...`               :ssooooossssssyyy+:------------::/++ooooooooooo+/:----.`   #    
#           .--..``-.--`              .oysssssssssshdo:----------::/++ossyhddhhdo....--------`   #    
#     ``    `:-.---:----`             .----------:+mh:------:://++oohhhdddddddddms`              #    
#    `.......-:----------.`          .-...```````..smy++//++ooooooooyddddddddddddmy`             #    
#      `.-------------------.`````..-/:--.....`````.:shhhdddho/::/+oohdddddhhhhhddms             #    
#         `-------....--------------/:-...````````````..----:/.` ``-/+hddddhhhddddmd:            #    
#           `.-----.--..-----------:/:-....````````````````..::``  `.:ommddhdddmmmmms            #    
#             `---------------::://++:--......``````````....--/:`````.:sdddmmmmmdddmh`           #    
#             .--------:://+++++//:-//:--.....................-/-````.-/yydhyyyhhhhdd`           #    
#           `..----:://///:--..``   :+::--------..............-//.```.-:sdhyyyyyhhhhd`           #    
#          ..--::://::-..-://+///:-`.o/::----.................-:+:.``..:+hyyyyyyhhhhs            #    
#         .-::-..`   `:+ooooooooooso/o+:::---------------------:++-....:/yyyyyyyyhhh:            #    
#          `        .syso+++++++oooosso+/::::::-----------::::::+s/-..--:shyyyyyhhys`            #    
#                `.../yysoooooo+oooossyso///::------------::://++yo:---:/ohyyyyhhys.             #    
#                :o+:`.oysoooooooooossyhhoo+:----------:::::://++dh+::::/+dhhhhhys.              #    
#                .ooo:``ohyssoooooosssyhhoooo+:------::::::////++ymo//::/+dhhddh/`               #    
#                 /sso:``ohyyssssssssyyhdysooooo/:::://++///++++shds+////+mddho-                 #    
#                  :sss/.`odhyyyyyyyyyyhdddyssooso///+oysooooosshNhso++//+hyo-                   #    
#                   -syy+-.sdhhhyyyyyyyyyyhhhyyssssoosyyysssyhdmNdysso++/ossso+/-.               #    
#                    `/syo:-sddhhhyyyyysssyyhhhhyyyysosssssossyyhyyssso+ossoo++//-               #    
#                      `+hy/-oddhhyyyyssssyyyhddddhh+  `/oosssssssssoo+ydhho/:-.`                #    
#                       :osso:+ddhhyyyssssyyyhddhhyo.   `/oosssssssssssyhhhhhhhhy+.              #    
#                        -sso+::yddhyyyyyyyyyhho `       `:+osssssssssyhsoshdhhhhddo-`           #    
#                         .oys/--odddhhhhyyhhhs.           .:osyyyyyyhsoooyhdhyssyhds/           #    
#                          `/yy+:-/dmdddhhhhyo.             `yhhhhhysoosyhddhsoosyyds-           #    
#                            .+ys+/+dmdddhy+.               `shyssoosyhdddhysooosyhdo-`          #    
#                              .+so:-/::-.                   `-+oshhhhhhyyssoooosyhd/-           #    
#                                ``                        .:+oooo++oooooooooooosyhh-.           #    
#                                                        `+oooo++++++++++++++ooosyho`            #    
#                                                        +ssooooo++++++++++++oosyhd/.            #    
#                                                       `yyysssoooooooo+++oooosyyhh-.            #    
#                                                        sdhhyyyssssssssssssyyyhhd+-.            #    
#                                                        .hmddddhhhhhhhhhhhhhddddo:-             #    
#                                                         `:ohddmmddddddddddhyso/::              #    
#                                                            -:/++ooooooo++//:--.`               #    
##################################################################################################
#                           ____       _                                                         #
#                          / ___| __ _| | __ _ _ __   __ _  __ _  ___                            #
#                         | |  _ / _` | |/ _` | '_ \ / _` |/ _` |/ _ \                           #
#                         | |_| | (_| | | (_| | |_) | (_| | (_| | (_) |                          # 
#                     _____\____|\__,_|_|\__,_| .__/ \__,_|\__, |\___/ _                         #  
#                    |  ___| __ __ _ _ __ ___ |_|____      |___/  _ __| | _                      #_
#                    | |_ | '__/ _` | '_ ` _ \ / _ \ \ /\ / / _ \| '__| |/ /                     #
#                    |  _|| | | (_| | | | | | |  __/\ V  V / (_) | |  |   <                      # 
#                    |_|  |_|  \__,_|_| |_| |_|\___| \_/\_/ \___/|_|  |_|\_\                     #
#                                                                                                # 
##################################################################################################

import ROOT as r
from   ROOT import gROOT, TCanvas, TFile, TGraphErrors, SetOwnership
import math, sys, optparse, array, copy
import gc, inspect

import include.Sample as Sample
import include.helper as helper
import include.Canvas as Canvas


class bcolors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'

    
def makePlot(lumi, treeSI, treeMC, var, name, xlabel, logx, LLlabel = False, normed = False):

    hMCS = treeMC.getLoopStack('histMC_'+name, var, xlabel)
    hSIS = treeSI.getLoopStack('histSI_'+name, var, xlabel)

    luminosity = lumi

    ### MC total histogram
    f = 0
    for _i, _h in enumerate(hMCS.GetHists()):
        if not f: hMC = copy.deepcopy(_h)
        else: hMC.Add(_h, 1.)
        f = 1

    #hMC.GetXaxis().SetTitle(hMCS.GetXaxis().GetTitle())

    ### Signal histograms
    s_histos = []
    for _i, _h in enumerate(hSIS.GetHists()):
        s_histos.append(copy.deepcopy(_h))

    # Normalization
    if normed:
        hMC.Scale(1.0/hMC.Integral())
        for _h in s_histos: _h.Scale(1.0/_h.Integral())
        luminosity = 1.0

    ### Get maximum
    maxValMC = hMC.GetMaximum()
    maxValSI = max([s_histos[i].GetMaximum() for i in range(0, len(s_histos))])
    maxVal = max(maxValMC, maxValSI)

    ### Set Maximum
    if not logx:
        hMCS.SetMaximum(1.3*maxVal)
        hMCS.SetMinimum(0.0)
        hMC.SetMaximum(1.3*maxVal)
        hMC.SetMinimum(0.0)
        for _h in s_histos: 
            _h.SetMaximum(1.3*maxVal)
            _h.SetMinimum(0.0)
    else:
        hMCS.SetMaximum(10.0*maxVal)
        hMCS.SetMinimum(0.1)
        hMC.SetMaximum(10.0*maxVal)
        hMC.SetMinimum(0.1)
        for _h in s_histos: 
            _h.SetMaximum(10.0*maxVal)
            _h.SetMinimum(0.1)


    ### Canvas object
    plot = Canvas.Canvas('hist_'+name, 'png', 0.62, 0.8, 0.9, 0.9)

    if normed: plot.addHisto(hMC, 'HIST', '', 'l', r.kBlue, 1, 0) # Background
    else: plot.addStack(hMCS, 'HIST', 1, 0) # Background

    for _h in s_histos:
        plot.addHisto(_h, 'HIST, SAME', '', 'l', _h.GetFillColor(), 1, 1) # Signal

    ### Dilepton banner
    if LLlabel == 'EE':
        plot.addLatex(0.17, 0.86, 'e^{+}e^{-} channel')
    if LLlabel == 'MM':
        plot.addLatex(0.17, 0.86, '#mu^{+}#mu^{-} channel')

    ### Save it
    plot.save(1, 0, logx, luminosity, '')



if __name__ == "__main__":

    print bcolors.HEADER
    print '########################################################################' 
    print '                  Starting IFCA-LLP analysis...                         '
    print '########################################################################' + bcolors.ENDC

    parser = optparse.OptionParser(usage='usage: %prog [opts] FilenameWithSamples', version='%prog 1.0')
    parser.add_option('-s', '--samples', action='store', type=str, dest='sampleFile', default='samples.dat', help='the samples file. default \'samples.dat\'')
    parser.add_option('-o', '--output', action='store', type=str, dest='outputFile', default='outputHistos.root', help='the output file. default \'outputHistograms.root\'')

    (opts, args) = parser.parse_args()


    ############# Initialize the output root file with the histos
    output = r.TFile(opts.outputFile, "RECREATE")
    output.Close()


    ############# Set the TDR plot style
    gROOT.ProcessLine('.L include/tdrstyle.C')
    gROOT.SetBatch(1)
    r.setTDRStyle()


    ############# Background definition
    Backgrounds = ['DYJets']


    ############# Signal definition
    Signal = ['ScalarBosons_1000_350_350',
              'ScalarBosons_200_50_200']


    ############# Parameter definition
    lumi = 21.79 # luminosity


    ############# Tree creation
    treeMC = Sample.Tree(helper.selectSamples(opts.sampleFile, Backgrounds, 'MC'), 'MC', 0)
    treeSI = Sample.Tree(helper.selectSamples(opts.sampleFile, Signal, 'MC'), 'MC', 0)


    ############# Tree loop
    treeMC.Loop(lumi, opts.outputFile, 50000)
    treeSI.Loop(lumi, opts.outputFile, 50000)


    makePlot(lumi, treeSI, treeMC, 'E1_pt', 'E1_pt', 'Leading electron p_{T}', 0, False, True)
    makePlot(lumi, treeSI, treeMC, 'E2_pt', 'E2_pt', 'Subleading electron p_{T}', 0, False, True)
    makePlot(lumi, treeSI, treeMC, 'E1_et', 'E1_et', 'Leading electron E_{T}', 0, False, True)
    makePlot(lumi, treeSI, treeMC, 'E2_et', 'E2_et', 'Subleading electron E_{T}', 0, False, True)
    makePlot(lumi, treeSI, treeMC, 'E1_eta', 'E1_eta', 'Leading electron #eta', 0, False, True)
    makePlot(lumi, treeSI, treeMC, 'E2_eta', 'E2_eta', 'Subleading electron #eta', 0, False, True)
    makePlot(lumi, treeSI, treeMC, 'E1_reliso', 'E1_reliso', 'Leading electron relIso', 0, False, True)
    makePlot(lumi, treeSI, treeMC, 'E2_reliso', 'E2_reliso', 'Subleading electron relIso', 0, False, True)

    makePlot(lumi, treeSI, treeMC, 'M1_pt', 'M1_pt', 'Leading muon p_{T}', 0, False, True)
    makePlot(lumi, treeSI, treeMC, 'M2_pt', 'M2_pt', 'Subleading muon p_{T}', 0, False, True)
    makePlot(lumi, treeSI, treeMC, 'M1_triggerPt', 'M1_triggerPt', 'Leading HLT muon p_{T}', 0, False, True)
    makePlot(lumi, treeSI, treeMC, 'M2_triggerPt', 'M2_triggerPt', 'Subleading HLT muon p_{T}', 0, False, True)
    makePlot(lumi, treeSI, treeMC, 'M1_eta', 'M1_eta', 'Leading muon #eta', 0, False, True)
    makePlot(lumi, treeSI, treeMC, 'M2_eta', 'M2_eta', 'Subleading muon #eta', 0, False, True)
    makePlot(lumi, treeSI, treeMC, 'M1_reliso', 'M1_reliso', 'Leading muon relIso', 0, False, True)
    makePlot(lumi, treeSI, treeMC, 'M2_reliso', 'M2_reliso', 'Subleading muon relIso', 0, False, True)

    
    makePlot(lumi, treeSI, treeMC, 'nEE', 'nEE', 'Number of EE', 1, 'EE')
    makePlot(lumi, treeSI, treeMC, 'EEsel_minIxy', 'EEsel_minIxy', '|d_{0}|/#sigma_{d}', 1, 'EE')
    makePlot(lumi, treeSI, treeMC, 'EEsel_invMass', 'EEsel_invMass', 'Mass (GeV/c^{2})', 1, 'EE')
    makePlot(lumi, treeSI, treeMC, 'EEsel_Chi2', 'EEsel_Chi2', 'Vertex #Chi^{2}', 1, 'EE')
    makePlot(lumi, treeSI, treeMC, 'EEsel_dPhi', 'EEsel_dPhi', 'Collinearity |#Delta#Phi|', 1, 'EE')
    makePlot(lumi, treeSI, treeMC, 'EEsel_leadingPt', 'EEsel_leadingPt', 'Leading p_{T} (GeV/c)', 1, 'EE')
    makePlot(lumi, treeSI, treeMC, 'EEsel_subleadingPt', 'EEsel_subleadingPt', 'Subleading p_{T} (GeV/c)', 1, 'EE')

    makePlot(lumi, treeSI, treeMC, 'nMM', 'nMM', 'Number of MM', 1, 'MM')
    makePlot(lumi, treeSI, treeMC, 'MMsel_minIxy', 'MMsel_minIxy', '|d_{0}|/#sigma_{d}', 1, 'MM')
    makePlot(lumi, treeSI, treeMC, 'MMsel_invMass', 'MMsel_invMass', 'Mass (GeV/c^{2})', 1, 'MM')
    makePlot(lumi, treeSI, treeMC, 'MMsel_Chi2', 'MMsel_Chi2', 'Vertex #Chi^{2}', 1, 'MM')
    makePlot(lumi, treeSI, treeMC, 'MMsel_dPhi', 'MMsel_dPhi', 'Collinearity |#Delta#Phi|', 1, 'MM')
    makePlot(lumi, treeSI, treeMC, 'MMsel_leadingPt', 'MMsel_leadingPt', 'Leading p_{T} (GeV/c)', 1, 'MM')
    makePlot(lumi, treeSI, treeMC, 'MMsel_subleadingPt', 'MMsel_subleadingPt', 'Subleading p_{T} (GeV/c)', 1, 'MM')
    makePlot(lumi, treeSI, treeMC, 'MMsel_cosAlpha', 'MMsel_cosAlpha', 'cos(#alpha)', 1, 'MM')
    


